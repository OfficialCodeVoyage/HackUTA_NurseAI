{"version":3,"sources":["../../../src/lib/eslint/runLintCheck.ts"],"sourcesContent":["import { promises as fs, existsSync } from 'fs'\nimport { bold, cyan, red, underline, yellow } from '../picocolors'\nimport path from 'path'\n\nimport findUp from 'next/dist/compiled/find-up'\nimport semver from 'next/dist/compiled/semver'\nimport * as CommentJson from 'next/dist/compiled/comment-json'\n\nimport { formatResults } from './customFormatter'\nimport type { LintResult } from './customFormatter'\nimport { writeDefaultConfig } from './writeDefaultConfig'\nimport { hasEslintConfiguration } from './hasEslintConfiguration'\nimport { writeOutputFile } from './writeOutputFile'\n\nimport { findPagesDir } from '../find-pages-dir'\nimport { installDependencies } from '../install-dependencies'\nimport { hasNecessaryDependencies } from '../has-necessary-dependencies'\n\nimport * as Log from '../../build/output/log'\nimport type { EventLintCheckCompleted } from '../../telemetry/events/build'\nimport isError, { getProperError } from '../is-error'\nimport { getPkgManager } from '../helpers/get-pkg-manager'\nimport {\n  getESLintStrictValue,\n  getESLintPromptValues,\n} from './getESLintPromptValues'\n\ntype Config = {\n  plugins: string[]\n  rules: { [key: string]: Array<number | string> }\n}\n\n// 0 is off, 1 is warn, 2 is error. See https://eslint.org/docs/user-guide/configuring/rules#configuring-rules\nconst VALID_SEVERITY = ['off', 'warn', 'error'] as const\ntype Severity = (typeof VALID_SEVERITY)[number]\n\nfunction isValidSeverity(severity: string): severity is Severity {\n  return VALID_SEVERITY.includes(severity as Severity)\n}\n\nconst requiredPackages = [\n  { file: 'eslint', pkg: 'eslint', exportsRestrict: false },\n  {\n    file: 'eslint-config-next',\n    pkg: 'eslint-config-next',\n    exportsRestrict: false,\n  },\n]\n\nasync function cliPrompt(cwd: string): Promise<{ config?: any }> {\n  console.log(\n    bold(\n      `${cyan(\n        '?'\n      )} How would you like to configure ESLint? https://nextjs.org/docs/basic-features/eslint`\n    )\n  )\n\n  try {\n    const cliSelect = (\n      await Promise.resolve(require('next/dist/compiled/cli-select'))\n    ).default\n    const { value } = await cliSelect({\n      values: await getESLintPromptValues(cwd),\n      valueRenderer: (\n        {\n          title,\n          recommended,\n        }: { title: string; recommended?: boolean; config: any },\n        selected: boolean\n      ) => {\n        const name = selected ? bold(underline(cyan(title))) : title\n        return name + (recommended ? bold(yellow(' (recommended)')) : '')\n      },\n      selected: cyan('‚ùØ '),\n      unselected: '  ',\n    })\n\n    return { config: value?.config ?? null }\n  } catch {\n    return { config: null }\n  }\n}\n\nasync function lint(\n  baseDir: string,\n  lintDirs: string[],\n  eslintrcFile: string | null,\n  pkgJsonPath: string | null,\n  {\n    lintDuringBuild = false,\n    eslintOptions = null,\n    reportErrorsOnly = false,\n    maxWarnings = -1,\n    formatter = null,\n    outputFile = null,\n  }: {\n    lintDuringBuild: boolean\n    eslintOptions: any\n    reportErrorsOnly: boolean\n    maxWarnings: number\n    formatter: string | null\n    outputFile: string | null\n  }\n): Promise<\n  | string\n  | null\n  | {\n      output: string | null\n      isError: boolean\n      eventInfo: EventLintCheckCompleted\n    }\n> {\n  try {\n    // Load ESLint after we're sure it exists:\n    const deps = await hasNecessaryDependencies(baseDir, requiredPackages)\n    const packageManager = getPkgManager(baseDir)\n\n    if (deps.missing.some((dep) => dep.pkg === 'eslint')) {\n      Log.error(\n        `ESLint must be installed${\n          lintDuringBuild ? ' in order to run during builds:' : ':'\n        } ${bold(\n          cyan(\n            (packageManager === 'yarn'\n              ? 'yarn add --dev'\n              : packageManager === 'pnpm'\n                ? 'pnpm install --save-dev'\n                : 'npm install --save-dev') + ' eslint'\n          )\n        )}`\n      )\n      return null\n    }\n\n    const mod = await Promise.resolve(require(deps.resolved.get('eslint')!))\n\n    const { ESLint } = mod\n    let eslintVersion = ESLint?.version ?? mod.CLIEngine?.version\n\n    if (!eslintVersion || semver.lt(eslintVersion, '7.0.0')) {\n      return `${red(\n        'error'\n      )} - Your project has an older version of ESLint installed${\n        eslintVersion ? ' (' + eslintVersion + ')' : ''\n      }. Please upgrade to ESLint version 7 or above`\n    }\n\n    let options: any = {\n      useEslintrc: true,\n      baseConfig: {},\n      errorOnUnmatchedPattern: false,\n      extensions: ['.js', '.jsx', '.ts', '.tsx'],\n      cache: true,\n      ...eslintOptions,\n    }\n\n    let eslint = new ESLint(options)\n\n    let nextEslintPluginIsEnabled = false\n    const nextRulesEnabled = new Map<string, Severity>()\n\n    for (const configFile of [eslintrcFile, pkgJsonPath]) {\n      if (!configFile) continue\n\n      const completeConfig: Config =\n        await eslint.calculateConfigForFile(configFile)\n\n      if (completeConfig.plugins?.includes('@next/next')) {\n        nextEslintPluginIsEnabled = true\n        for (const [name, [severity]] of Object.entries(completeConfig.rules)) {\n          if (!name.startsWith('@next/next/')) {\n            continue\n          }\n          if (\n            typeof severity === 'number' &&\n            severity >= 0 &&\n            severity < VALID_SEVERITY.length\n          ) {\n            nextRulesEnabled.set(name, VALID_SEVERITY[severity])\n          } else if (\n            typeof severity === 'string' &&\n            isValidSeverity(severity)\n          ) {\n            nextRulesEnabled.set(name, severity)\n          }\n        }\n        break\n      }\n    }\n\n    const pagesDir = findPagesDir(baseDir).pagesDir\n    const pagesDirRules = pagesDir ? ['@next/next/no-html-link-for-pages'] : []\n\n    if (nextEslintPluginIsEnabled) {\n      let updatedPagesDir = false\n\n      for (const rule of pagesDirRules) {\n        if (\n          !options.baseConfig!.rules?.[rule] &&\n          !options.baseConfig!.rules?.[\n            rule.replace('@next/next', '@next/babel-plugin-next')\n          ]\n        ) {\n          if (!options.baseConfig!.rules) {\n            options.baseConfig!.rules = {}\n          }\n          options.baseConfig!.rules[rule] = [1, pagesDir]\n          updatedPagesDir = true\n        }\n      }\n\n      if (updatedPagesDir) {\n        eslint = new ESLint(options)\n      }\n    } else {\n      Log.warn('')\n      Log.warn(\n        'The Next.js plugin was not detected in your ESLint configuration. See https://nextjs.org/docs/basic-features/eslint#migrating-existing-config'\n      )\n    }\n\n    const lintStart = process.hrtime()\n\n    let results = await eslint.lintFiles(lintDirs)\n    let selectedFormatter = null\n\n    if (options.fix) await ESLint.outputFixes(results)\n    if (reportErrorsOnly) results = await ESLint.getErrorResults(results) // Only return errors if --quiet flag is used\n\n    if (formatter) selectedFormatter = await eslint.loadFormatter(formatter)\n    const formattedResult = formatResults(\n      baseDir,\n      results,\n      selectedFormatter?.format\n    )\n    const lintEnd = process.hrtime(lintStart)\n    const totalWarnings = results.reduce(\n      (sum: number, file: LintResult) => sum + file.warningCount,\n      0\n    )\n\n    if (outputFile) await writeOutputFile(outputFile, formattedResult.output)\n\n    return {\n      output: formattedResult.outputWithMessages,\n      isError:\n        ESLint.getErrorResults(results)?.length > 0 ||\n        (maxWarnings >= 0 && totalWarnings > maxWarnings),\n      eventInfo: {\n        durationInSeconds: lintEnd[0],\n        eslintVersion: eslintVersion,\n        lintedFilesCount: results.length,\n        lintFix: !!options.fix,\n        nextEslintPluginVersion:\n          nextEslintPluginIsEnabled && deps.resolved.has('eslint-config-next')\n            ? require(\n                path.join(\n                  path.dirname(deps.resolved.get('eslint-config-next')!),\n                  'package.json'\n                )\n              ).version\n            : null,\n        nextEslintPluginErrorsCount: formattedResult.totalNextPluginErrorCount,\n        nextEslintPluginWarningsCount:\n          formattedResult.totalNextPluginWarningCount,\n        nextRulesEnabled: Object.fromEntries(nextRulesEnabled),\n      },\n    }\n  } catch (err) {\n    if (lintDuringBuild) {\n      Log.error(\n        `ESLint: ${\n          isError(err) && err.message ? err.message.replace(/\\n/g, ' ') : err\n        }`\n      )\n      return null\n    } else {\n      throw getProperError(err)\n    }\n  }\n}\n\nexport async function runLintCheck(\n  baseDir: string,\n  lintDirs: string[],\n  opts: {\n    lintDuringBuild?: boolean\n    eslintOptions?: any\n    reportErrorsOnly?: boolean\n    maxWarnings?: number\n    formatter?: string | null\n    outputFile?: string | null\n    strict?: boolean\n  }\n): ReturnType<typeof lint> {\n  const {\n    lintDuringBuild = false,\n    eslintOptions = null,\n    reportErrorsOnly = false,\n    maxWarnings = -1,\n    formatter = null,\n    outputFile = null,\n    strict = false,\n  } = opts\n  try {\n    // Find user's .eslintrc file\n    // See: https://eslint.org/docs/user-guide/configuring/configuration-files#configuration-file-formats\n    const eslintrcFile =\n      (await findUp(\n        [\n          '.eslintrc.js',\n          '.eslintrc.cjs',\n          '.eslintrc.yaml',\n          '.eslintrc.yml',\n          '.eslintrc.json',\n          '.eslintrc',\n        ],\n        {\n          cwd: baseDir,\n        }\n      )) ?? null\n\n    const pkgJsonPath = (await findUp('package.json', { cwd: baseDir })) ?? null\n    let packageJsonConfig = null\n    if (pkgJsonPath) {\n      const pkgJsonContent = await fs.readFile(pkgJsonPath, {\n        encoding: 'utf8',\n      })\n      packageJsonConfig = CommentJson.parse(pkgJsonContent)\n    }\n\n    const config = await hasEslintConfiguration(eslintrcFile, packageJsonConfig)\n    let deps\n\n    if (config.exists) {\n      // Run if ESLint config exists\n      return await lint(baseDir, lintDirs, eslintrcFile, pkgJsonPath, {\n        lintDuringBuild,\n        eslintOptions,\n        reportErrorsOnly,\n        maxWarnings,\n        formatter,\n        outputFile,\n      })\n    } else {\n      // Display warning if no ESLint configuration is present inside\n      // config file during \"next build\", no warning is shown when\n      // no eslintrc file is present\n      if (lintDuringBuild) {\n        if (config.emptyPkgJsonConfig || config.emptyEslintrc) {\n          Log.warn(\n            `No ESLint configuration detected. Run ${bold(\n              cyan('next lint')\n            )} to begin setup`\n          )\n        }\n        return null\n      } else {\n        // Ask user what config they would like to start with for first time \"next lint\" setup\n        const { config: selectedConfig } = strict\n          ? await getESLintStrictValue(baseDir)\n          : await cliPrompt(baseDir)\n\n        if (selectedConfig == null) {\n          // Show a warning if no option is selected in prompt\n          Log.warn(\n            'If you set up ESLint yourself, we recommend adding the Next.js ESLint plugin. See https://nextjs.org/docs/basic-features/eslint#migrating-existing-config'\n          )\n          return null\n        } else {\n          // Check if necessary deps installed, and install any that are missing\n          deps = await hasNecessaryDependencies(baseDir, requiredPackages)\n          if (deps.missing.length > 0) {\n            deps.missing.forEach((dep) => {\n              if (dep.pkg === 'eslint') {\n                // eslint v9 has breaking changes, so lock to 8 until dependency plugins fully support v9.\n                dep.pkg = 'eslint@^8'\n              }\n            })\n\n            await installDependencies(baseDir, deps.missing, true)\n          }\n\n          // Write default ESLint config.\n          // Check for /pages and src/pages is to make sure this happens in Next.js folder\n          if (\n            ['app', 'src/app', 'pages', 'src/pages'].some((dir) =>\n              existsSync(path.join(baseDir, dir))\n            )\n          ) {\n            await writeDefaultConfig(\n              baseDir,\n              config,\n              selectedConfig,\n              eslintrcFile,\n              pkgJsonPath,\n              packageJsonConfig\n            )\n          }\n        }\n\n        Log.ready(\n          `ESLint has successfully been configured. Run ${bold(\n            cyan('next lint')\n          )} again to view warnings and errors.`\n        )\n\n        return null\n      }\n    }\n  } catch (err) {\n    throw err\n  }\n}\n"],"names":["runLintCheck","VALID_SEVERITY","isValidSeverity","severity","includes","requiredPackages","file","pkg","exportsRestrict","cliPrompt","cwd","console","log","bold","cyan","cliSelect","Promise","resolve","require","default","value","values","getESLintPromptValues","valueRenderer","title","recommended","selected","name","underline","yellow","unselected","config","lint","baseDir","lintDirs","eslintrcFile","pkgJsonPath","lintDuringBuild","eslintOptions","reportErrorsOnly","maxWarnings","formatter","outputFile","mod","ESLint","deps","hasNecessaryDependencies","packageManager","getPkgManager","missing","some","dep","Log","error","resolved","get","eslintVersion","version","CLIEngine","semver","lt","red","options","useEslintrc","baseConfig","errorOnUnmatchedPattern","extensions","cache","eslint","nextEslintPluginIsEnabled","nextRulesEnabled","Map","configFile","completeConfig","calculateConfigForFile","plugins","Object","entries","rules","startsWith","length","set","pagesDir","findPagesDir","pagesDirRules","updatedPagesDir","rule","replace","warn","lintStart","process","hrtime","results","lintFiles","selectedFormatter","fix","outputFixes","getErrorResults","loadFormatter","formattedResult","formatResults","format","lintEnd","totalWarnings","reduce","sum","warningCount","writeOutputFile","output","outputWithMessages","isError","eventInfo","durationInSeconds","lintedFilesCount","lintFix","nextEslintPluginVersion","has","path","join","dirname","nextEslintPluginErrorsCount","totalNextPluginErrorCount","nextEslintPluginWarningsCount","totalNextPluginWarningCount","fromEntries","err","message","getProperError","opts","strict","findUp","packageJsonConfig","pkgJsonContent","fs","readFile","encoding","CommentJson","parse","hasEslintConfiguration","exists","emptyPkgJsonConfig","emptyEslintrc","selectedConfig","getESLintStrictValue","forEach","installDependencies","dir","existsSync","writeDefaultConfig","ready"],"mappings":"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"}