{"version":3,"sources":["../../../src/build/flying-shuttle/detect-changed-entries.ts"],"sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport crypto from 'crypto'\nimport { getPageFromPath } from '../entries'\nimport { Sema } from 'next/dist/compiled/async-sema'\n\nexport interface DetectedEntriesResult {\n  app: string[]\n  pages: string[]\n}\n\nlet _hasShuttle: undefined | boolean = undefined\nexport async function hasShuttle(shuttleDir: string) {\n  if (typeof _hasShuttle === 'boolean') {\n    return _hasShuttle\n  }\n  _hasShuttle = await fs.promises\n    .access(path.join(shuttleDir, 'server'))\n    .then(() => true)\n    .catch(() => false)\n\n  return _hasShuttle\n}\n\nexport async function detectChangedEntries({\n  appPaths,\n  pagesPaths,\n  pageExtensions,\n  distDir,\n  shuttleDir,\n}: {\n  appPaths?: string[]\n  pagesPaths?: string[]\n  pageExtensions: string[]\n  distDir: string\n  shuttleDir: string\n}): Promise<{\n  changed: DetectedEntriesResult\n  unchanged: DetectedEntriesResult\n}> {\n  const changedEntries: {\n    app: string[]\n    pages: string[]\n  } = {\n    app: [],\n    pages: [],\n  }\n  const unchangedEntries: typeof changedEntries = {\n    app: [],\n    pages: [],\n  }\n\n  if (!(await hasShuttle(shuttleDir))) {\n    // no shuttle so consider everything changed\n    console.log(`no shuttle. can't detect changes`)\n    return {\n      changed: {\n        pages: pagesPaths || [],\n        app: appPaths || [],\n      },\n      unchanged: {\n        pages: [],\n        app: [],\n      },\n    }\n  }\n\n  const hashCache = new Map<string, string>()\n\n  async function computeHash(p: string): Promise<string> {\n    let hash = hashCache.get(p)\n    if (hash) {\n      return hash\n    }\n    return new Promise((resolve, reject) => {\n      const hashInst = crypto.createHash('sha1')\n      const stream = fs.createReadStream(p)\n      stream.on('error', (err) => reject(err))\n      stream.on('data', (chunk) => hashInst.update(chunk))\n      stream.on('end', () => {\n        const digest = hashInst.digest('hex')\n        resolve(digest)\n        hashCache.set(p, digest)\n      })\n    })\n  }\n\n  const hashSema = new Sema(16)\n  let globalEntryChanged = false\n\n  async function detectChange({\n    normalizedEntry,\n    entry,\n    type,\n  }: {\n    entry: string\n    normalizedEntry: string\n    type: keyof typeof changedEntries\n  }) {\n    const traceFile = path.join(\n      shuttleDir,\n      'server',\n      type,\n      `${normalizedEntry}.js.nft.json`\n    )\n    let changed = true\n\n    // we don't need to check any further entry's dependencies if\n    // a global entry changed since that invalidates everything\n    if (!globalEntryChanged) {\n      try {\n        const traceData: {\n          fileHashes: Record<string, string>\n        } = JSON.parse(await fs.promises.readFile(traceFile, 'utf8'))\n\n        if (traceData) {\n          let changedDependency = false\n          await Promise.all(\n            Object.keys(traceData.fileHashes).map(async (file) => {\n              try {\n                if (changedDependency) return\n                await hashSema.acquire()\n                const relativeTraceFile = path.relative(\n                  path.join(shuttleDir, 'server', type),\n                  traceFile\n                )\n                const originalTraceFile = path.join(\n                  distDir,\n                  'server',\n                  type,\n                  relativeTraceFile\n                )\n                const absoluteFile = path.join(\n                  path.dirname(originalTraceFile),\n                  file\n                )\n\n                if (absoluteFile.startsWith(distDir)) {\n                  return\n                }\n\n                const prevHash = traceData.fileHashes[file]\n                const curHash = await computeHash(absoluteFile)\n\n                if (prevHash !== curHash) {\n                  console.log('detected change on', {\n                    prevHash,\n                    curHash,\n                    file,\n                    entry: normalizedEntry,\n                  })\n                  changedDependency = true\n                }\n              } finally {\n                hashSema.release()\n              }\n            })\n          )\n\n          if (!changedDependency) {\n            changed = false\n          }\n        } else {\n          console.error('missing trace data', traceFile, normalizedEntry)\n        }\n      } catch (err) {\n        console.error(`Failed to detect change for ${entry}`, err)\n      }\n    }\n\n    // we always rebuild global entries so we have a version\n    // that matches the newest build/runtime\n    const isGlobalEntry = /(_app|_document|_error)/.test(entry)\n\n    if (changed || isGlobalEntry) {\n      // if a global entry changed all entries are changed\n      if (!globalEntryChanged && isGlobalEntry) {\n        console.log(`global entry ${entry} changed invalidating all entries`)\n        globalEntryChanged = true\n        // move unchanged to changed\n        changedEntries[type].push(...unchangedEntries[type])\n      }\n      changedEntries[type].push(entry)\n    } else {\n      unchangedEntries[type].push(entry)\n    }\n  }\n\n  // loop over entries and their dependency's hashes\n  // to detect which changed\n  for (const entry of pagesPaths || []) {\n    let normalizedEntry = getPageFromPath(entry, pageExtensions)\n\n    if (normalizedEntry === '/') {\n      normalizedEntry = '/index'\n    }\n    await detectChange({ entry, normalizedEntry, type: 'pages' })\n  }\n\n  for (const entry of appPaths || []) {\n    const normalizedEntry = getPageFromPath(entry, pageExtensions)\n    await detectChange({ entry, normalizedEntry, type: 'app' })\n  }\n\n  console.log(\n    'changed entries',\n    JSON.stringify(\n      {\n        changedEntries,\n        unchangedEntries,\n      },\n      null,\n      2\n    )\n  )\n\n  return {\n    changed: changedEntries,\n    unchanged: unchangedEntries,\n  }\n}\n"],"names":["detectChangedEntries","hasShuttle","_hasShuttle","undefined","shuttleDir","fs","promises","access","path","join","then","catch","appPaths","pagesPaths","pageExtensions","distDir","changedEntries","app","pages","unchangedEntries","console","log","changed","unchanged","hashCache","Map","computeHash","p","hash","get","Promise","resolve","reject","hashInst","crypto","createHash","stream","createReadStream","on","err","chunk","update","digest","set","hashSema","Sema","globalEntryChanged","detectChange","normalizedEntry","entry","type","traceFile","traceData","JSON","parse","readFile","changedDependency","all","Object","keys","fileHashes","map","file","acquire","relativeTraceFile","relative","originalTraceFile","absoluteFile","dirname","startsWith","prevHash","curHash","release","error","isGlobalEntry","test","push","getPageFromPath","stringify"],"mappings":"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"}