{"version":3,"sources":["../../../src/server/base-http/web.ts"],"sourcesContent":["import type { IncomingHttpHeaders, OutgoingHttpHeaders } from 'http'\nimport type { FetchMetrics } from './index'\n\nimport { toNodeOutgoingHttpHeaders } from '../web/utils'\nimport { BaseNextRequest, BaseNextResponse } from './index'\nimport { DetachedPromise } from '../../lib/detached-promise'\nimport type { NextRequestHint } from '../web/adapter'\nimport { CloseController, trackBodyConsumed } from '../web/web-on-close'\nimport { InvariantError } from '../../shared/lib/invariant-error'\n\nexport class WebNextRequest extends BaseNextRequest<ReadableStream | null> {\n  public request: Request\n  public headers: IncomingHttpHeaders\n  public fetchMetrics?: FetchMetrics\n\n  constructor(request: NextRequestHint) {\n    const url = new URL(request.url)\n\n    super(\n      request.method,\n      url.href.slice(url.origin.length),\n      request.clone().body\n    )\n    this.request = request\n    this.fetchMetrics = request.fetchMetrics\n\n    this.headers = {}\n    for (const [name, value] of request.headers.entries()) {\n      this.headers[name] = value\n    }\n  }\n\n  async parseBody(_limit: string | number): Promise<any> {\n    throw new Error('parseBody is not implemented in the web runtime')\n  }\n}\n\nexport class WebNextResponse extends BaseNextResponse<WritableStream> {\n  private headers = new Headers()\n  private textBody: string | undefined = undefined\n\n  private closeController = new CloseController()\n\n  public statusCode: number | undefined\n  public statusMessage: string | undefined\n\n  constructor(\n    public transformStream = new TransformStream(),\n    private trackOnClose = false\n  ) {\n    super(transformStream.writable)\n  }\n\n  setHeader(name: string, value: string | string[]): this {\n    this.headers.delete(name)\n    for (const val of Array.isArray(value) ? value : [value]) {\n      this.headers.append(name, val)\n    }\n    return this\n  }\n\n  removeHeader(name: string): this {\n    this.headers.delete(name)\n    return this\n  }\n\n  getHeaderValues(name: string): string[] | undefined {\n    // https://developer.mozilla.org/docs/Web/API/Headers/get#example\n    return this.getHeader(name)\n      ?.split(',')\n      .map((v) => v.trimStart())\n  }\n\n  getHeader(name: string): string | undefined {\n    return this.headers.get(name) ?? undefined\n  }\n\n  getHeaders(): OutgoingHttpHeaders {\n    return toNodeOutgoingHttpHeaders(this.headers)\n  }\n\n  hasHeader(name: string): boolean {\n    return this.headers.has(name)\n  }\n\n  appendHeader(name: string, value: string): this {\n    this.headers.append(name, value)\n    return this\n  }\n\n  body(value: string) {\n    this.textBody = value\n    return this\n  }\n\n  private readonly sendPromise = new DetachedPromise<void>()\n\n  private _sent = false\n  public send() {\n    this.sendPromise.resolve()\n    this._sent = true\n  }\n\n  get sent() {\n    return this._sent\n  }\n\n  public async toResponse() {\n    // If we haven't called `send` yet, wait for it to be called.\n    if (!this.sent) await this.sendPromise.promise\n\n    const body = this.textBody ?? this.transformStream.readable\n\n    let bodyInit: BodyInit = body\n\n    const canAddListenersLater = typeof bodyInit !== 'string'\n    const shouldTrackBody =\n      this.trackOnClose &&\n      (canAddListenersLater ? true : this.closeController.listeners > 0)\n\n    if (shouldTrackBody) {\n      bodyInit = trackBodyConsumed(body, () => {\n        this.closeController.dispatchClose()\n      })\n    }\n\n    return new Response(bodyInit, {\n      headers: this.headers,\n      status: this.statusCode,\n      statusText: this.statusMessage,\n    })\n  }\n\n  public onClose(callback: () => void) {\n    if (!this.trackOnClose) {\n      throw new InvariantError(\n        'Cannot call onClose on a WebNextResponse initialized with `trackOnClose = false`'\n      )\n    }\n    if (this.closeController.isClosed) {\n      throw new InvariantError(\n        'Cannot call onClose on a WebNextResponse that is already closed'\n      )\n    }\n    return this.closeController.onClose(callback)\n  }\n}\n"],"names":["toNodeOutgoingHttpHeaders","BaseNextRequest","BaseNextResponse","DetachedPromise","CloseController","trackBodyConsumed","InvariantError","WebNextRequest","constructor","request","url","URL","method","href","slice","origin","length","clone","body","fetchMetrics","headers","name","value","entries","parseBody","_limit","Error","WebNextResponse","transformStream","TransformStream","trackOnClose","writable","Headers","textBody","undefined","closeController","sendPromise","_sent","setHeader","delete","val","Array","isArray","append","removeHeader","getHeaderValues","getHeader","split","map","v","trimStart","get","getHeaders","hasHeader","has","appendHeader","send","resolve","sent","toResponse","promise","readable","bodyInit","canAddListenersLater","shouldTrackBody","listeners","dispatchClose","Response","status","statusCode","statusText","statusMessage","onClose","callback","isClosed"],"mappings":"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"}