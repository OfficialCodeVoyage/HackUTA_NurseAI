{"version":3,"sources":["../../../src/server/app-render/encryption.ts"],"sourcesContent":["/* eslint-disable import/no-extraneous-dependencies */\nimport 'server-only'\n\n/* eslint-disable import/no-extraneous-dependencies */\nimport {\n  renderToReadableStream,\n  decodeReply,\n} from 'react-server-dom-webpack/server.edge'\n/* eslint-disable import/no-extraneous-dependencies */\nimport {\n  createFromReadableStream,\n  encodeReply,\n} from 'react-server-dom-webpack/client.edge'\n\nimport { streamToString } from '../stream-utils/node-web-streams-helper'\nimport {\n  arrayBufferToString,\n  decrypt,\n  encrypt,\n  getActionEncryptionKey,\n  getClientReferenceManifestSingleton,\n  getServerModuleMap,\n  stringToUint8Array,\n} from './encryption-utils'\n\nconst textEncoder = new TextEncoder()\nconst textDecoder = new TextDecoder()\n\nasync function decodeActionBoundArg(actionId: string, arg: string) {\n  const key = await getActionEncryptionKey()\n  if (typeof key === 'undefined') {\n    throw new Error(\n      `Missing encryption key for Server Action. This is a bug in Next.js`\n    )\n  }\n\n  // Get the iv (16 bytes) and the payload from the arg.\n  const originalPayload = atob(arg)\n  const ivValue = originalPayload.slice(0, 16)\n  const payload = originalPayload.slice(16)\n\n  const decrypted = textDecoder.decode(\n    await decrypt(key, stringToUint8Array(ivValue), stringToUint8Array(payload))\n  )\n\n  if (!decrypted.startsWith(actionId)) {\n    throw new Error('Invalid Server Action payload: failed to decrypt.')\n  }\n\n  return decrypted.slice(actionId.length)\n}\n\nasync function encodeActionBoundArg(actionId: string, arg: string) {\n  const key = await getActionEncryptionKey()\n  if (key === undefined) {\n    throw new Error(\n      `Missing encryption key for Server Action. This is a bug in Next.js`\n    )\n  }\n\n  // Get 16 random bytes as iv.\n  const randomBytes = new Uint8Array(16)\n  crypto.getRandomValues(randomBytes)\n  const ivValue = arrayBufferToString(randomBytes.buffer)\n\n  const encrypted = await encrypt(\n    key,\n    randomBytes,\n    textEncoder.encode(actionId + arg)\n  )\n\n  return btoa(ivValue + arrayBufferToString(encrypted))\n}\n\n// Encrypts the action's bound args into a string.\nexport async function encryptActionBoundArgs(actionId: string, args: any[]) {\n  const clientReferenceManifestSingleton = getClientReferenceManifestSingleton()\n\n  // Using Flight to serialize the args into a string.\n  const serialized = await streamToString(\n    renderToReadableStream(args, clientReferenceManifestSingleton.clientModules)\n  )\n\n  // Encrypt the serialized string with the action id as the salt.\n  // Add a prefix to later ensure that the payload is correctly decrypted, similar\n  // to a checksum.\n  const encrypted = await encodeActionBoundArg(actionId, serialized)\n\n  return encrypted\n}\n\n// Decrypts the action's bound args from the encrypted string.\nexport async function decryptActionBoundArgs(\n  actionId: string,\n  encrypted: Promise<string>\n) {\n  // Decrypt the serialized string with the action id as the salt.\n  const decryped = await decodeActionBoundArg(actionId, await encrypted)\n\n  // Using Flight to deserialize the args from the string.\n  const deserialized = await createFromReadableStream(\n    new ReadableStream({\n      start(controller) {\n        controller.enqueue(textEncoder.encode(decryped))\n        controller.close()\n      },\n    }),\n    {\n      ssrManifest: {\n        // TODO: We can't use the client reference manifest to resolve the modules\n        // on the server side - instead they need to be recovered as the module\n        // references (proxies) again.\n        // For now, we'll just use an empty module map.\n        moduleLoading: {},\n        moduleMap: {},\n      },\n    }\n  )\n\n  // This extra step ensures that the server references are recovered.\n  const serverModuleMap = getServerModuleMap()\n  const transformed = await decodeReply(\n    await encodeReply(deserialized),\n    serverModuleMap\n  )\n\n  return transformed\n}\n"],"names":["renderToReadableStream","decodeReply","createFromReadableStream","encodeReply","streamToString","arrayBufferToString","decrypt","encrypt","getActionEncryptionKey","getClientReferenceManifestSingleton","getServerModuleMap","stringToUint8Array","textEncoder","TextEncoder","textDecoder","TextDecoder","decodeActionBoundArg","actionId","arg","key","Error","originalPayload","atob","ivValue","slice","payload","decrypted","decode","startsWith","length","encodeActionBoundArg","undefined","randomBytes","Uint8Array","crypto","getRandomValues","buffer","encrypted","encode","btoa","encryptActionBoundArgs","args","clientReferenceManifestSingleton","serialized","clientModules","decryptActionBoundArgs","decryped","deserialized","ReadableStream","start","controller","enqueue","close","ssrManifest","moduleLoading","moduleMap","serverModuleMap","transformed"],"mappings":"AAAA,oDAAoD,GACpD,OAAO,cAAa;AAEpB,oDAAoD,GACpD,SACEA,sBAAsB,EACtBC,WAAW,QACN,uCAAsC;AAC7C,oDAAoD,GACpD,SACEC,wBAAwB,EACxBC,WAAW,QACN,uCAAsC;AAE7C,SAASC,cAAc,QAAQ,0CAAyC;AACxE,SACEC,mBAAmB,EACnBC,OAAO,EACPC,OAAO,EACPC,sBAAsB,EACtBC,mCAAmC,EACnCC,kBAAkB,EAClBC,kBAAkB,QACb,qBAAoB;AAE3B,MAAMC,cAAc,IAAIC;AACxB,MAAMC,cAAc,IAAIC;AAExB,eAAeC,qBAAqBC,QAAgB,EAAEC,GAAW;IAC/D,MAAMC,MAAM,MAAMX;IAClB,IAAI,OAAOW,QAAQ,aAAa;QAC9B,MAAM,IAAIC,MACR,CAAC,kEAAkE,CAAC;IAExE;IAEA,sDAAsD;IACtD,MAAMC,kBAAkBC,KAAKJ;IAC7B,MAAMK,UAAUF,gBAAgBG,KAAK,CAAC,GAAG;IACzC,MAAMC,UAAUJ,gBAAgBG,KAAK,CAAC;IAEtC,MAAME,YAAYZ,YAAYa,MAAM,CAClC,MAAMrB,QAAQa,KAAKR,mBAAmBY,UAAUZ,mBAAmBc;IAGrE,IAAI,CAACC,UAAUE,UAAU,CAACX,WAAW;QACnC,MAAM,IAAIG,MAAM;IAClB;IAEA,OAAOM,UAAUF,KAAK,CAACP,SAASY,MAAM;AACxC;AAEA,eAAeC,qBAAqBb,QAAgB,EAAEC,GAAW;IAC/D,MAAMC,MAAM,MAAMX;IAClB,IAAIW,QAAQY,WAAW;QACrB,MAAM,IAAIX,MACR,CAAC,kEAAkE,CAAC;IAExE;IAEA,6BAA6B;IAC7B,MAAMY,cAAc,IAAIC,WAAW;IACnCC,OAAOC,eAAe,CAACH;IACvB,MAAMT,UAAUlB,oBAAoB2B,YAAYI,MAAM;IAEtD,MAAMC,YAAY,MAAM9B,QACtBY,KACAa,aACApB,YAAY0B,MAAM,CAACrB,WAAWC;IAGhC,OAAOqB,KAAKhB,UAAUlB,oBAAoBgC;AAC5C;AAEA,kDAAkD;AAClD,OAAO,eAAeG,uBAAuBvB,QAAgB,EAAEwB,IAAW;IACxE,MAAMC,mCAAmCjC;IAEzC,oDAAoD;IACpD,MAAMkC,aAAa,MAAMvC,eACvBJ,uBAAuByC,MAAMC,iCAAiCE,aAAa;IAG7E,gEAAgE;IAChE,gFAAgF;IAChF,iBAAiB;IACjB,MAAMP,YAAY,MAAMP,qBAAqBb,UAAU0B;IAEvD,OAAON;AACT;AAEA,8DAA8D;AAC9D,OAAO,eAAeQ,uBACpB5B,QAAgB,EAChBoB,SAA0B;IAE1B,gEAAgE;IAChE,MAAMS,WAAW,MAAM9B,qBAAqBC,UAAU,MAAMoB;IAE5D,wDAAwD;IACxD,MAAMU,eAAe,MAAM7C,yBACzB,IAAI8C,eAAe;QACjBC,OAAMC,UAAU;YACdA,WAAWC,OAAO,CAACvC,YAAY0B,MAAM,CAACQ;YACtCI,WAAWE,KAAK;QAClB;IACF,IACA;QACEC,aAAa;YACX,0EAA0E;YAC1E,uEAAuE;YACvE,8BAA8B;YAC9B,+CAA+C;YAC/CC,eAAe,CAAC;YAChBC,WAAW,CAAC;QACd;IACF;IAGF,oEAAoE;IACpE,MAAMC,kBAAkB9C;IACxB,MAAM+C,cAAc,MAAMxD,YACxB,MAAME,YAAY4C,eAClBS;IAGF,OAAOC;AACT"}