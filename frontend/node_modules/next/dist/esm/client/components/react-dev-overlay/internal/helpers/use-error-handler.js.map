{"version":3,"sources":["../../../../../../src/client/components/react-dev-overlay/internal/helpers/use-error-handler.ts"],"sourcesContent":["import { useEffect } from 'react'\n\nimport { isNextRouterError } from '../../../is-next-router-error'\nimport { isHydrationError } from '../../../is-hydration-error'\nimport { attachHydrationErrorState } from './attach-hydration-error-state'\n\nexport type ErrorHandler = (error: Error) => void\n\nif (typeof window !== 'undefined') {\n  try {\n    // Increase the number of stack frames on the client\n    Error.stackTraceLimit = 50\n  } catch {}\n}\n\nlet hasHydrationError = false\nconst errorQueue: Array<Error> = []\nconst rejectionQueue: Array<Error> = []\nconst errorHandlers: Array<ErrorHandler> = []\nconst rejectionHandlers: Array<ErrorHandler> = []\n\nexport function handleClientError(error: unknown) {\n  if (!error || !(error instanceof Error) || typeof error.stack !== 'string') {\n    // A non-error was thrown, we don't have anything to show. :-(\n    return\n  }\n\n  attachHydrationErrorState(error)\n\n  // Only queue one hydration every time\n  if (isHydrationError(error)) {\n    if (!hasHydrationError) {\n      errorQueue.push(error)\n    }\n    hasHydrationError = true\n  }\n  for (const handler of errorHandlers) {\n    handler(error)\n  }\n}\nif (typeof window !== 'undefined') {\n  // These event handlers must be added outside of the hook because there is no\n  // guarantee that the hook will be alive in a mounted component in time to\n  // when the errors occur.\n  // uncaught errors go through reportError\n  window.addEventListener(\n    'error',\n    (event: WindowEventMap['error']): void | boolean => {\n      if (isNextRouterError(event.error)) {\n        event.preventDefault()\n        return false\n      }\n      handleClientError(event.error)\n    }\n  )\n\n  window.addEventListener(\n    'unhandledrejection',\n    (ev: WindowEventMap['unhandledrejection']): void => {\n      const reason = ev?.reason\n      if (\n        !reason ||\n        !(reason instanceof Error) ||\n        typeof reason.stack !== 'string'\n      ) {\n        // A non-error was thrown, we don't have anything to show. :-(\n        return\n      }\n\n      const e = reason\n      rejectionQueue.push(e)\n      for (const handler of rejectionHandlers) {\n        handler(e)\n      }\n    }\n  )\n}\n\nexport function useErrorHandler(\n  handleOnUnhandledError: ErrorHandler,\n  handleOnUnhandledRejection: ErrorHandler\n) {\n  useEffect(() => {\n    // Handle queued errors.\n    errorQueue.forEach(handleOnUnhandledError)\n    rejectionQueue.forEach(handleOnUnhandledRejection)\n\n    // Listen to new errors.\n    errorHandlers.push(handleOnUnhandledError)\n    rejectionHandlers.push(handleOnUnhandledRejection)\n\n    return () => {\n      // Remove listeners.\n      errorHandlers.splice(errorHandlers.indexOf(handleOnUnhandledError), 1)\n      rejectionHandlers.splice(\n        rejectionHandlers.indexOf(handleOnUnhandledRejection),\n        1\n      )\n    }\n  }, [handleOnUnhandledError, handleOnUnhandledRejection])\n}\n"],"names":["useEffect","isNextRouterError","isHydrationError","attachHydrationErrorState","window","Error","stackTraceLimit","hasHydrationError","errorQueue","rejectionQueue","errorHandlers","rejectionHandlers","handleClientError","error","stack","push","handler","addEventListener","event","preventDefault","ev","reason","e","useErrorHandler","handleOnUnhandledError","handleOnUnhandledRejection","forEach","splice","indexOf"],"mappings":"AAAA,SAASA,SAAS,QAAQ,QAAO;AAEjC,SAASC,iBAAiB,QAAQ,gCAA+B;AACjE,SAASC,gBAAgB,QAAQ,8BAA6B;AAC9D,SAASC,yBAAyB,QAAQ,iCAAgC;AAI1E,IAAI,OAAOC,WAAW,aAAa;IACjC,IAAI;QACF,oDAAoD;QACpDC,MAAMC,eAAe,GAAG;IAC1B,EAAE,UAAM,CAAC;AACX;AAEA,IAAIC,oBAAoB;AACxB,MAAMC,aAA2B,EAAE;AACnC,MAAMC,iBAA+B,EAAE;AACvC,MAAMC,gBAAqC,EAAE;AAC7C,MAAMC,oBAAyC,EAAE;AAEjD,OAAO,SAASC,kBAAkBC,KAAc;IAC9C,IAAI,CAACA,SAAS,CAAEA,CAAAA,iBAAiBR,KAAI,KAAM,OAAOQ,MAAMC,KAAK,KAAK,UAAU;QAC1E,8DAA8D;QAC9D;IACF;IAEAX,0BAA0BU;IAE1B,sCAAsC;IACtC,IAAIX,iBAAiBW,QAAQ;QAC3B,IAAI,CAACN,mBAAmB;YACtBC,WAAWO,IAAI,CAACF;QAClB;QACAN,oBAAoB;IACtB;IACA,KAAK,MAAMS,WAAWN,cAAe;QACnCM,QAAQH;IACV;AACF;AACA,IAAI,OAAOT,WAAW,aAAa;IACjC,6EAA6E;IAC7E,0EAA0E;IAC1E,yBAAyB;IACzB,yCAAyC;IACzCA,OAAOa,gBAAgB,CACrB,SACA,CAACC;QACC,IAAIjB,kBAAkBiB,MAAML,KAAK,GAAG;YAClCK,MAAMC,cAAc;YACpB,OAAO;QACT;QACAP,kBAAkBM,MAAML,KAAK;IAC/B;IAGFT,OAAOa,gBAAgB,CACrB,sBACA,CAACG;QACC,MAAMC,SAASD,sBAAAA,GAAIC,MAAM;QACzB,IACE,CAACA,UACD,CAAEA,CAAAA,kBAAkBhB,KAAI,KACxB,OAAOgB,OAAOP,KAAK,KAAK,UACxB;YACA,8DAA8D;YAC9D;QACF;QAEA,MAAMQ,IAAID;QACVZ,eAAeM,IAAI,CAACO;QACpB,KAAK,MAAMN,WAAWL,kBAAmB;YACvCK,QAAQM;QACV;IACF;AAEJ;AAEA,OAAO,SAASC,gBACdC,sBAAoC,EACpCC,0BAAwC;IAExCzB,UAAU;QACR,wBAAwB;QACxBQ,WAAWkB,OAAO,CAACF;QACnBf,eAAeiB,OAAO,CAACD;QAEvB,wBAAwB;QACxBf,cAAcK,IAAI,CAACS;QACnBb,kBAAkBI,IAAI,CAACU;QAEvB,OAAO;YACL,oBAAoB;YACpBf,cAAciB,MAAM,CAACjB,cAAckB,OAAO,CAACJ,yBAAyB;YACpEb,kBAAkBgB,MAAM,CACtBhB,kBAAkBiB,OAAO,CAACH,6BAC1B;QAEJ;IACF,GAAG;QAACD;QAAwBC;KAA2B;AACzD"}