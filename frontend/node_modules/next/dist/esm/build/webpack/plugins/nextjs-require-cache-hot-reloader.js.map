{"version":3,"sources":["../../../../src/build/webpack/plugins/nextjs-require-cache-hot-reloader.ts"],"sourcesContent":["import type { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { clearModuleContext } from '../../../server/web/sandbox'\nimport { realpathSync } from '../../../lib/realpath'\nimport path from 'path'\nimport isError from '../../../lib/is-error'\nimport { clearManifestCache } from '../../../server/load-manifest'\n\ntype Compiler = webpack.Compiler\ntype WebpackPluginInstance = webpack.WebpackPluginInstance\n\nconst originModules = [\n  require.resolve('../../../server/require'),\n  require.resolve('../../../server/load-components'),\n  require.resolve('../../../server/next-server'),\n  require.resolve('next/dist/compiled/next-server/app-page.runtime.dev.js'),\n  require.resolve('next/dist/compiled/next-server/app-route.runtime.dev.js'),\n  require.resolve('next/dist/compiled/next-server/pages.runtime.dev.js'),\n  require.resolve('next/dist/compiled/next-server/pages-api.runtime.dev.js'),\n]\n\nconst RUNTIME_NAMES = ['webpack-runtime', 'webpack-api-runtime']\n\nfunction deleteFromRequireCache(filePath: string) {\n  try {\n    filePath = realpathSync(filePath)\n  } catch (e) {\n    if (isError(e) && e.code !== 'ENOENT') throw e\n  }\n  const mod = require.cache[filePath]\n  if (mod) {\n    // remove the child reference from the originModules\n    for (const originModule of originModules) {\n      const parent = require.cache[originModule]\n      if (parent) {\n        const idx = parent.children.indexOf(mod)\n        if (idx >= 0) parent.children.splice(idx, 1)\n      }\n    }\n    // remove parent references from external modules\n    for (const child of mod.children) {\n      child.parent = null\n    }\n    delete require.cache[filePath]\n    return true\n  }\n  return false\n}\n\nexport function deleteAppClientCache() {\n  deleteFromRequireCache(\n    require.resolve('next/dist/compiled/next-server/app-page.runtime.dev.js')\n  )\n  deleteFromRequireCache(\n    require.resolve(\n      'next/dist/compiled/next-server/app-page-experimental.runtime.dev.js'\n    )\n  )\n}\n\nexport function deleteCache(filePath: string) {\n  // try to clear it from the fs cache\n  clearManifestCache(filePath)\n\n  deleteFromRequireCache(filePath)\n}\n\nconst PLUGIN_NAME = 'NextJsRequireCacheHotReloader'\n\n// This plugin flushes require.cache after emitting the files. Providing 'hot reloading' of server files.\nexport class NextJsRequireCacheHotReloader implements WebpackPluginInstance {\n  prevAssets: any = null\n  serverComponents: boolean\n\n  constructor(opts: { serverComponents: boolean }) {\n    this.serverComponents = opts.serverComponents\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.assetEmitted.tap(PLUGIN_NAME, (_file, { targetPath }) => {\n      // Clear module context in this process\n      clearModuleContext(targetPath)\n      deleteCache(targetPath)\n    })\n\n    compiler.hooks.afterEmit.tapPromise(PLUGIN_NAME, async (compilation) => {\n      for (const name of RUNTIME_NAMES) {\n        const runtimeChunkPath = path.join(\n          compilation.outputOptions.path!,\n          `${name}.js`\n        )\n        deleteCache(runtimeChunkPath)\n      }\n\n      // we need to make sure to clear all server entries from cache\n      // since they can have a stale webpack-runtime cache\n      // which needs to always be in-sync\n      let hasAppEntry = false\n      const entries = [...compilation.entries.keys()].filter((entry) => {\n        const isAppPath = entry.toString().startsWith('app/')\n        if (isAppPath) hasAppEntry = true\n        return entry.toString().startsWith('pages/') || isAppPath\n      })\n\n      if (hasAppEntry) {\n        deleteAppClientCache()\n      }\n\n      for (const page of entries) {\n        const outputPath = path.join(\n          compilation.outputOptions.path!,\n          page + '.js'\n        )\n        deleteCache(outputPath)\n      }\n    })\n  }\n}\n"],"names":["clearModuleContext","realpathSync","path","isError","clearManifestCache","originModules","require","resolve","RUNTIME_NAMES","deleteFromRequireCache","filePath","e","code","mod","cache","originModule","parent","idx","children","indexOf","splice","child","deleteAppClientCache","deleteCache","PLUGIN_NAME","NextJsRequireCacheHotReloader","constructor","opts","prevAssets","serverComponents","apply","compiler","hooks","assetEmitted","tap","_file","targetPath","afterEmit","tapPromise","compilation","name","runtimeChunkPath","join","outputOptions","hasAppEntry","entries","keys","filter","entry","isAppPath","toString","startsWith","page","outputPath"],"mappings":"AACA,SAASA,kBAAkB,QAAQ,8BAA6B;AAChE,SAASC,YAAY,QAAQ,wBAAuB;AACpD,OAAOC,UAAU,OAAM;AACvB,OAAOC,aAAa,wBAAuB;AAC3C,SAASC,kBAAkB,QAAQ,gCAA+B;AAKlE,MAAMC,gBAAgB;IACpBC,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;IAChBD,QAAQC,OAAO,CAAC;CACjB;AAED,MAAMC,gBAAgB;IAAC;IAAmB;CAAsB;AAEhE,SAASC,uBAAuBC,QAAgB;IAC9C,IAAI;QACFA,WAAWT,aAAaS;IAC1B,EAAE,OAAOC,GAAG;QACV,IAAIR,QAAQQ,MAAMA,EAAEC,IAAI,KAAK,UAAU,MAAMD;IAC/C;IACA,MAAME,MAAMP,QAAQQ,KAAK,CAACJ,SAAS;IACnC,IAAIG,KAAK;QACP,oDAAoD;QACpD,KAAK,MAAME,gBAAgBV,cAAe;YACxC,MAAMW,SAASV,QAAQQ,KAAK,CAACC,aAAa;YAC1C,IAAIC,QAAQ;gBACV,MAAMC,MAAMD,OAAOE,QAAQ,CAACC,OAAO,CAACN;gBACpC,IAAII,OAAO,GAAGD,OAAOE,QAAQ,CAACE,MAAM,CAACH,KAAK;YAC5C;QACF;QACA,iDAAiD;QACjD,KAAK,MAAMI,SAASR,IAAIK,QAAQ,CAAE;YAChCG,MAAML,MAAM,GAAG;QACjB;QACA,OAAOV,QAAQQ,KAAK,CAACJ,SAAS;QAC9B,OAAO;IACT;IACA,OAAO;AACT;AAEA,OAAO,SAASY;IACdb,uBACEH,QAAQC,OAAO,CAAC;IAElBE,uBACEH,QAAQC,OAAO,CACb;AAGN;AAEA,OAAO,SAASgB,YAAYb,QAAgB;IAC1C,oCAAoC;IACpCN,mBAAmBM;IAEnBD,uBAAuBC;AACzB;AAEA,MAAMc,cAAc;AAEpB,yGAAyG;AACzG,OAAO,MAAMC;IAIXC,YAAYC,IAAmC,CAAE;aAHjDC,aAAkB;QAIhB,IAAI,CAACC,gBAAgB,GAAGF,KAAKE,gBAAgB;IAC/C;IAEAC,MAAMC,QAAkB,EAAE;QACxBA,SAASC,KAAK,CAACC,YAAY,CAACC,GAAG,CAACV,aAAa,CAACW,OAAO,EAAEC,UAAU,EAAE;YACjE,uCAAuC;YACvCpC,mBAAmBoC;YACnBb,YAAYa;QACd;QAEAL,SAASC,KAAK,CAACK,SAAS,CAACC,UAAU,CAACd,aAAa,OAAOe;YACtD,KAAK,MAAMC,QAAQhC,cAAe;gBAChC,MAAMiC,mBAAmBvC,KAAKwC,IAAI,CAChCH,YAAYI,aAAa,CAACzC,IAAI,EAC9B,CAAC,EAAEsC,KAAK,GAAG,CAAC;gBAEdjB,YAAYkB;YACd;YAEA,8DAA8D;YAC9D,oDAAoD;YACpD,mCAAmC;YACnC,IAAIG,cAAc;YAClB,MAAMC,UAAU;mBAAIN,YAAYM,OAAO,CAACC,IAAI;aAAG,CAACC,MAAM,CAAC,CAACC;gBACtD,MAAMC,YAAYD,MAAME,QAAQ,GAAGC,UAAU,CAAC;gBAC9C,IAAIF,WAAWL,cAAc;gBAC7B,OAAOI,MAAME,QAAQ,GAAGC,UAAU,CAAC,aAAaF;YAClD;YAEA,IAAIL,aAAa;gBACftB;YACF;YAEA,KAAK,MAAM8B,QAAQP,QAAS;gBAC1B,MAAMQ,aAAanD,KAAKwC,IAAI,CAC1BH,YAAYI,aAAa,CAACzC,IAAI,EAC9BkD,OAAO;gBAET7B,YAAY8B;YACd;QACF;IACF;AACF"}