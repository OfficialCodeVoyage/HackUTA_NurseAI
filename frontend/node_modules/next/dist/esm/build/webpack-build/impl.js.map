{"version":3,"sources":["../../../src/build/webpack-build/impl.ts"],"sourcesContent":["import type { webpack } from 'next/dist/compiled/webpack/webpack'\nimport { stringBufferUtils } from 'next/dist/compiled/webpack-sources3'\nimport { red } from '../../lib/picocolors'\nimport formatWebpackMessages from '../../client/components/react-dev-overlay/internal/helpers/format-webpack-messages'\nimport { nonNullable } from '../../lib/non-nullable'\nimport type { COMPILER_INDEXES } from '../../shared/lib/constants'\nimport {\n  COMPILER_NAMES,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN_APP,\n  APP_CLIENT_INTERNALS,\n  PHASE_PRODUCTION_BUILD,\n} from '../../shared/lib/constants'\nimport { runCompiler } from '../compiler'\nimport * as Log from '../output/log'\nimport getBaseWebpackConfig, { loadProjectInfo } from '../webpack-config'\nimport type { NextError } from '../../lib/is-error'\nimport {\n  TelemetryPlugin,\n  type TelemetryPluginState,\n} from '../webpack/plugins/telemetry-plugin'\nimport {\n  NextBuildContext,\n  resumePluginState,\n  getPluginState,\n} from '../build-context'\nimport { createEntrypoints } from '../entries'\nimport loadConfig from '../../server/config'\nimport {\n  getTraceEvents,\n  initializeTraceState,\n  setGlobal,\n  trace,\n  type TraceEvent,\n  type TraceState,\n} from '../../trace'\nimport { WEBPACK_LAYERS } from '../../lib/constants'\nimport { TraceEntryPointsPlugin } from '../webpack/plugins/next-trace-entrypoints-plugin'\nimport type { BuildTraceContext } from '../webpack/plugins/next-trace-entrypoints-plugin'\nimport type { UnwrapPromise } from '../../lib/coalesced-function'\n\nimport origDebug from 'next/dist/compiled/debug'\nimport { Telemetry } from '../../telemetry/storage'\n\nconst debug = origDebug('next:build:webpack-build')\n\ntype CompilerResult = {\n  errors: webpack.StatsError[]\n  warnings: webpack.StatsError[]\n  stats: (webpack.Stats | undefined)[]\n}\n\ntype SingleCompilerResult = {\n  errors: webpack.StatsError[]\n  warnings: webpack.StatsError[]\n  stats: webpack.Stats | undefined\n}\n\nfunction isTelemetryPlugin(plugin: unknown): plugin is TelemetryPlugin {\n  return plugin instanceof TelemetryPlugin\n}\n\nfunction isTraceEntryPointsPlugin(\n  plugin: unknown\n): plugin is TraceEntryPointsPlugin {\n  return plugin instanceof TraceEntryPointsPlugin\n}\n\nexport async function webpackBuildImpl(\n  compilerName: keyof typeof COMPILER_INDEXES | null\n): Promise<{\n  duration: number\n  pluginState: any\n  buildTraceContext?: BuildTraceContext\n  telemetryState?: TelemetryPluginState\n}> {\n  let result: CompilerResult | null = {\n    warnings: [],\n    errors: [],\n    stats: [],\n  }\n  let webpackBuildStart\n  const nextBuildSpan = NextBuildContext.nextBuildSpan!\n  const dir = NextBuildContext.dir!\n  const config = NextBuildContext.config!\n\n  const runWebpackSpan = nextBuildSpan.traceChild('run-webpack-compiler')\n  const entrypoints = await nextBuildSpan\n    .traceChild('create-entrypoints')\n    .traceAsyncFn(() =>\n      createEntrypoints({\n        buildId: NextBuildContext.buildId!,\n        config: config,\n        envFiles: NextBuildContext.loadedEnvFiles!,\n        isDev: false,\n        rootDir: dir,\n        pageExtensions: config.pageExtensions!,\n        pagesDir: NextBuildContext.pagesDir!,\n        appDir: NextBuildContext.appDir!,\n        pages: NextBuildContext.mappedPages!,\n        appPaths: NextBuildContext.mappedAppPages!,\n        previewMode: NextBuildContext.previewProps!,\n        rootPaths: NextBuildContext.mappedRootPaths!,\n        hasInstrumentationHook: NextBuildContext.hasInstrumentationHook!,\n      })\n    )\n\n  const commonWebpackOptions = {\n    isServer: false,\n    buildId: NextBuildContext.buildId!,\n    encryptionKey: NextBuildContext.encryptionKey!,\n    config: config,\n    appDir: NextBuildContext.appDir!,\n    pagesDir: NextBuildContext.pagesDir!,\n    rewrites: NextBuildContext.rewrites!,\n    originalRewrites: NextBuildContext.originalRewrites,\n    originalRedirects: NextBuildContext.originalRedirects,\n    reactProductionProfiling: NextBuildContext.reactProductionProfiling!,\n    noMangling: NextBuildContext.noMangling!,\n    clientRouterFilters: NextBuildContext.clientRouterFilters!,\n    previewModeId: NextBuildContext.previewModeId!,\n    allowedRevalidateHeaderKeys: NextBuildContext.allowedRevalidateHeaderKeys!,\n    fetchCacheKeyPrefix: NextBuildContext.fetchCacheKeyPrefix!,\n  }\n\n  const configs = await runWebpackSpan\n    .traceChild('generate-webpack-config')\n    .traceAsyncFn(async () => {\n      const info = await loadProjectInfo({\n        dir,\n        config: commonWebpackOptions.config,\n        dev: false,\n      })\n      return Promise.all([\n        getBaseWebpackConfig(dir, {\n          ...commonWebpackOptions,\n          middlewareMatchers: entrypoints.middlewareMatchers,\n          runWebpackSpan,\n          compilerType: COMPILER_NAMES.client,\n          entrypoints: entrypoints.client,\n          ...info,\n        }),\n        getBaseWebpackConfig(dir, {\n          ...commonWebpackOptions,\n          runWebpackSpan,\n          middlewareMatchers: entrypoints.middlewareMatchers,\n          compilerType: COMPILER_NAMES.server,\n          entrypoints: entrypoints.server,\n          ...info,\n        }),\n        getBaseWebpackConfig(dir, {\n          ...commonWebpackOptions,\n          runWebpackSpan,\n          middlewareMatchers: entrypoints.middlewareMatchers,\n          compilerType: COMPILER_NAMES.edgeServer,\n          entrypoints: entrypoints.edgeServer,\n          edgePreviewProps: {\n            __NEXT_PREVIEW_MODE_ID:\n              NextBuildContext.previewProps!.previewModeId,\n            __NEXT_PREVIEW_MODE_ENCRYPTION_KEY:\n              NextBuildContext.previewProps!.previewModeEncryptionKey,\n            __NEXT_PREVIEW_MODE_SIGNING_KEY:\n              NextBuildContext.previewProps!.previewModeSigningKey,\n          },\n          ...info,\n        }),\n      ])\n    })\n\n  const clientConfig = configs[0]\n  const serverConfig = configs[1]\n  const edgeConfig = configs[2]\n\n  if (\n    clientConfig.optimization &&\n    (clientConfig.optimization.minimize !== true ||\n      (clientConfig.optimization.minimizer &&\n        clientConfig.optimization.minimizer.length === 0))\n  ) {\n    Log.warn(\n      `Production code optimization has been disabled in your project. Read more: https://nextjs.org/docs/messages/minification-disabled`\n    )\n  }\n\n  webpackBuildStart = process.hrtime()\n\n  debug(`starting compiler`, compilerName)\n  // We run client and server compilation separately to optimize for memory usage\n  await runWebpackSpan.traceAsyncFn(async () => {\n    if (config.experimental.webpackMemoryOptimizations) {\n      stringBufferUtils.disableDualStringBufferCaching()\n      stringBufferUtils.enterStringInterningRange()\n    }\n\n    // Run the server compilers first and then the client\n    // compiler to track the boundary of server/client components.\n    let clientResult: SingleCompilerResult | null = null\n\n    // During the server compilations, entries of client components will be\n    // injected to this set and then will be consumed by the client compiler.\n    let serverResult: UnwrapPromise<ReturnType<typeof runCompiler>>[0] | null =\n      null\n    let edgeServerResult:\n      | UnwrapPromise<ReturnType<typeof runCompiler>>[0]\n      | null = null\n\n    let inputFileSystem: webpack.Compiler['inputFileSystem'] | undefined\n\n    if (!compilerName || compilerName === 'server') {\n      debug('starting server compiler')\n      const start = Date.now()\n      ;[serverResult, inputFileSystem] = await runCompiler(serverConfig, {\n        runWebpackSpan,\n        inputFileSystem,\n      })\n      debug(`server compiler finished ${Date.now() - start}ms`)\n    }\n\n    if (!compilerName || compilerName === 'edge-server') {\n      debug('starting edge-server compiler')\n      const start = Date.now()\n      ;[edgeServerResult, inputFileSystem] = edgeConfig\n        ? await runCompiler(edgeConfig, { runWebpackSpan, inputFileSystem })\n        : [null]\n      debug(`edge-server compiler finished ${Date.now() - start}ms`)\n    }\n\n    // Only continue if there were no errors\n    if (!serverResult?.errors.length && !edgeServerResult?.errors.length) {\n      const pluginState = getPluginState()\n      for (const key in pluginState.injectedClientEntries) {\n        const value = pluginState.injectedClientEntries[key]\n        const clientEntry = clientConfig.entry as webpack.EntryObject\n        if (key === APP_CLIENT_INTERNALS) {\n          clientEntry[CLIENT_STATIC_FILES_RUNTIME_MAIN_APP] = {\n            import: [\n              // TODO-APP: cast clientEntry[CLIENT_STATIC_FILES_RUNTIME_MAIN_APP] to type EntryDescription once it's available from webpack\n              // @ts-expect-error clientEntry['main-app'] is type EntryDescription { import: ... }\n              ...clientEntry[CLIENT_STATIC_FILES_RUNTIME_MAIN_APP].import,\n              value,\n            ],\n            layer: WEBPACK_LAYERS.appPagesBrowser,\n          }\n        } else {\n          clientEntry[key] = {\n            dependOn: [CLIENT_STATIC_FILES_RUNTIME_MAIN_APP],\n            import: value,\n            layer: WEBPACK_LAYERS.appPagesBrowser,\n          }\n        }\n      }\n\n      if (!compilerName || compilerName === 'client') {\n        debug('starting client compiler')\n        const start = Date.now()\n        ;[clientResult, inputFileSystem] = await runCompiler(clientConfig, {\n          runWebpackSpan,\n          inputFileSystem,\n        })\n        debug(`client compiler finished ${Date.now() - start}ms`)\n      }\n    }\n\n    if (config.experimental.webpackMemoryOptimizations) {\n      stringBufferUtils.exitStringInterningRange()\n    }\n    inputFileSystem?.purge?.()\n\n    result = {\n      warnings: [\n        ...(clientResult?.warnings ?? []),\n        ...(serverResult?.warnings ?? []),\n        ...(edgeServerResult?.warnings ?? []),\n      ].filter(nonNullable),\n      errors: [\n        ...(clientResult?.errors ?? []),\n        ...(serverResult?.errors ?? []),\n        ...(edgeServerResult?.errors ?? []),\n      ].filter(nonNullable),\n      stats: [\n        clientResult?.stats,\n        serverResult?.stats,\n        edgeServerResult?.stats,\n      ],\n    }\n  })\n  result = nextBuildSpan\n    .traceChild('format-webpack-messages')\n    .traceFn(() => formatWebpackMessages(result, true)) as CompilerResult\n\n  const telemetryPlugin = (clientConfig as webpack.Configuration).plugins?.find(\n    isTelemetryPlugin\n  )\n\n  const traceEntryPointsPlugin = (\n    serverConfig as webpack.Configuration\n  ).plugins?.find(isTraceEntryPointsPlugin)\n\n  const webpackBuildEnd = process.hrtime(webpackBuildStart)\n\n  if (result.errors.length > 0) {\n    // Only keep the first few errors. Others are often indicative\n    // of the same problem, but confuse the reader with noise.\n    if (result.errors.length > 5) {\n      result.errors.length = 5\n    }\n    let error = result.errors.filter(Boolean).join('\\n\\n')\n\n    console.error(red('Failed to compile.\\n'))\n\n    if (\n      error.indexOf('private-next-pages') > -1 &&\n      error.indexOf('does not contain a default export') > -1\n    ) {\n      const page_name_regex = /'private-next-pages\\/(?<page_name>[^']*)'/\n      const parsed = page_name_regex.exec(error)\n      const page_name = parsed && parsed.groups && parsed.groups.page_name\n      throw new Error(\n        `webpack build failed: found page without a React Component as default export in pages/${page_name}\\n\\nSee https://nextjs.org/docs/messages/page-without-valid-component for more info.`\n      )\n    }\n\n    console.error(error)\n    console.error()\n\n    if (\n      error.indexOf('private-next-pages') > -1 ||\n      error.indexOf('__next_polyfill__') > -1\n    ) {\n      const err = new Error(\n        'webpack config.resolve.alias was incorrectly overridden. https://nextjs.org/docs/messages/invalid-resolve-alias'\n      ) as NextError\n      err.code = 'INVALID_RESOLVE_ALIAS'\n      throw err\n    }\n    const err = new Error('Build failed because of webpack errors') as NextError\n    err.code = 'WEBPACK_ERRORS'\n    throw err\n  } else {\n    if (result.warnings.length > 0) {\n      Log.warn('Compiled with warnings\\n')\n      console.warn(result.warnings.filter(Boolean).join('\\n\\n'))\n      console.warn()\n    } else if (!compilerName) {\n      Log.event('Compiled successfully')\n    }\n\n    return {\n      duration: webpackBuildEnd[0],\n      buildTraceContext: traceEntryPointsPlugin?.buildTraceContext,\n      pluginState: getPluginState(),\n      telemetryState: {\n        usages: telemetryPlugin?.usages() || [],\n        packagesUsedInServerSideProps:\n          telemetryPlugin?.packagesUsedInServerSideProps() || [],\n      },\n    }\n  }\n}\n\n// the main function when this file is run as a worker\nexport async function workerMain(workerData: {\n  compilerName: keyof typeof COMPILER_INDEXES\n  buildContext: typeof NextBuildContext\n  traceState: TraceState\n}): Promise<\n  Awaited<ReturnType<typeof webpackBuildImpl>> & {\n    debugTraceEvents: TraceEvent[]\n  }\n> {\n  // Clone the telemetry for worker\n  const telemetry = new Telemetry({\n    distDir: workerData.buildContext.config!.distDir,\n  })\n  setGlobal('telemetry', telemetry)\n  // setup new build context from the serialized data passed from the parent\n  Object.assign(NextBuildContext, workerData.buildContext)\n\n  // Initialize tracer state from the parent\n  initializeTraceState(workerData.traceState)\n\n  // Resume plugin state\n  resumePluginState(NextBuildContext.pluginState)\n\n  /// load the config because it's not serializable\n  NextBuildContext.config = await loadConfig(\n    PHASE_PRODUCTION_BUILD,\n    NextBuildContext.dir!\n  )\n  NextBuildContext.nextBuildSpan = trace(\n    `worker-main-${workerData.compilerName}`\n  )\n\n  const result = await webpackBuildImpl(workerData.compilerName)\n  const { entriesTrace, chunksTrace } = result.buildTraceContext ?? {}\n  if (entriesTrace) {\n    const { entryNameMap, depModArray } = entriesTrace\n    if (depModArray) {\n      result.buildTraceContext!.entriesTrace!.depModArray = depModArray\n    }\n    if (entryNameMap) {\n      const entryEntries = entryNameMap\n      result.buildTraceContext!.entriesTrace!.entryNameMap = entryEntries\n    }\n  }\n  if (chunksTrace?.entryNameFilesMap) {\n    const entryNameFilesMap = chunksTrace.entryNameFilesMap\n    result.buildTraceContext!.chunksTrace!.entryNameFilesMap = entryNameFilesMap\n  }\n  NextBuildContext.nextBuildSpan.stop()\n  return { ...result, debugTraceEvents: getTraceEvents() }\n}\n"],"names":["stringBufferUtils","red","formatWebpackMessages","nonNullable","COMPILER_NAMES","CLIENT_STATIC_FILES_RUNTIME_MAIN_APP","APP_CLIENT_INTERNALS","PHASE_PRODUCTION_BUILD","runCompiler","Log","getBaseWebpackConfig","loadProjectInfo","TelemetryPlugin","NextBuildContext","resumePluginState","getPluginState","createEntrypoints","loadConfig","getTraceEvents","initializeTraceState","setGlobal","trace","WEBPACK_LAYERS","TraceEntryPointsPlugin","origDebug","Telemetry","debug","isTelemetryPlugin","plugin","isTraceEntryPointsPlugin","webpackBuildImpl","compilerName","result","warnings","errors","stats","webpackBuildStart","nextBuildSpan","dir","config","runWebpackSpan","traceChild","entrypoints","traceAsyncFn","buildId","envFiles","loadedEnvFiles","isDev","rootDir","pageExtensions","pagesDir","appDir","pages","mappedPages","appPaths","mappedAppPages","previewMode","previewProps","rootPaths","mappedRootPaths","hasInstrumentationHook","commonWebpackOptions","isServer","encryptionKey","rewrites","originalRewrites","originalRedirects","reactProductionProfiling","noMangling","clientRouterFilters","previewModeId","allowedRevalidateHeaderKeys","fetchCacheKeyPrefix","configs","info","dev","Promise","all","middlewareMatchers","compilerType","client","server","edgeServer","edgePreviewProps","__NEXT_PREVIEW_MODE_ID","__NEXT_PREVIEW_MODE_ENCRYPTION_KEY","previewModeEncryptionKey","__NEXT_PREVIEW_MODE_SIGNING_KEY","previewModeSigningKey","clientConfig","serverConfig","edgeConfig","optimization","minimize","minimizer","length","warn","process","hrtime","inputFileSystem","experimental","webpackMemoryOptimizations","disableDualStringBufferCaching","enterStringInterningRange","clientResult","serverResult","edgeServerResult","start","Date","now","pluginState","key","injectedClientEntries","value","clientEntry","entry","import","layer","appPagesBrowser","dependOn","exitStringInterningRange","purge","filter","traceFn","telemetryPlugin","plugins","find","traceEntryPointsPlugin","webpackBuildEnd","error","Boolean","join","console","indexOf","page_name_regex","parsed","exec","page_name","groups","Error","err","code","event","duration","buildTraceContext","telemetryState","usages","packagesUsedInServerSideProps","workerMain","workerData","telemetry","distDir","buildContext","Object","assign","traceState","entriesTrace","chunksTrace","entryNameMap","depModArray","entryEntries","entryNameFilesMap","stop","debugTraceEvents"],"mappings":"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"}