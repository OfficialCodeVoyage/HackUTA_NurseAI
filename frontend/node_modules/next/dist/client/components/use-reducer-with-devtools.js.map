{"version":3,"sources":["../../../src/client/components/use-reducer-with-devtools.ts"],"sourcesContent":["import type { Dispatch } from 'react'\nimport React, { use } from 'react'\nimport { useRef, useEffect, useCallback } from 'react'\nimport {\n  isThenable,\n  type AppRouterState,\n  type ReducerActions,\n  type ReducerState,\n} from './router-reducer/router-reducer-types'\nimport type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n\nexport type ReduxDevtoolsSyncFn = (state: AppRouterState) => void\n\nfunction normalizeRouterState(val: any): any {\n  if (val instanceof Map) {\n    const obj: { [key: string]: any } = {}\n    for (const [key, value] of val.entries()) {\n      if (typeof value === 'function') {\n        obj[key] = 'fn()'\n        continue\n      }\n      if (typeof value === 'object' && value !== null) {\n        if (value.$$typeof) {\n          obj[key] = value.$$typeof.toString()\n          continue\n        }\n        if (value._bundlerConfig) {\n          obj[key] = 'FlightData'\n          continue\n        }\n      }\n      obj[key] = normalizeRouterState(value)\n    }\n    return obj\n  }\n\n  if (typeof val === 'object' && val !== null) {\n    const obj: { [key: string]: any } = {}\n    for (const key in val) {\n      const value = val[key]\n      if (typeof value === 'function') {\n        obj[key] = 'fn()'\n        continue\n      }\n      if (typeof value === 'object' && value !== null) {\n        if (value.$$typeof) {\n          obj[key] = value.$$typeof.toString()\n          continue\n        }\n        if (value.hasOwnProperty('_bundlerConfig')) {\n          obj[key] = 'FlightData'\n          continue\n        }\n      }\n\n      obj[key] = normalizeRouterState(value)\n    }\n    return obj\n  }\n\n  if (Array.isArray(val)) {\n    return val.map(normalizeRouterState)\n  }\n\n  return val\n}\n\ndeclare global {\n  interface Window {\n    __REDUX_DEVTOOLS_EXTENSION__: any\n  }\n}\n\nexport interface ReduxDevToolsInstance {\n  send(action: any, state: any): void\n  init(initialState: any): void\n}\n\nexport function useUnwrapState(state: ReducerState): AppRouterState {\n  // reducer actions can be async, so sometimes we need to suspend until the state is resolved\n  if (isThenable(state)) {\n    const result = use(state)\n    return result\n  }\n\n  return state\n}\n\nexport function useReducerWithReduxDevtools(\n  actionQueue: AppRouterActionQueue\n): [ReducerState, Dispatch<ReducerActions>, ReduxDevtoolsSyncFn] {\n  const [state, setState] = React.useState<ReducerState>(actionQueue.state)\n  const devtoolsConnectionRef = useRef<ReduxDevToolsInstance>(undefined)\n  const enabledRef = useRef<boolean>(undefined)\n\n  useEffect(() => {\n    if (devtoolsConnectionRef.current || enabledRef.current === false) {\n      return\n    }\n\n    if (\n      enabledRef.current === undefined &&\n      typeof window.__REDUX_DEVTOOLS_EXTENSION__ === 'undefined'\n    ) {\n      enabledRef.current = false\n      return\n    }\n\n    devtoolsConnectionRef.current = window.__REDUX_DEVTOOLS_EXTENSION__.connect(\n      {\n        instanceId: 8000, // Random number that is high to avoid conflicts\n        name: 'next-router',\n      }\n    )\n    if (devtoolsConnectionRef.current) {\n      devtoolsConnectionRef.current.init(\n        normalizeRouterState(actionQueue.state)\n      )\n\n      if (actionQueue) {\n        actionQueue.devToolsInstance = devtoolsConnectionRef.current\n      }\n    }\n\n    return () => {\n      devtoolsConnectionRef.current = undefined\n    }\n  }, [actionQueue])\n\n  const dispatch = useCallback(\n    (action: ReducerActions) => {\n      actionQueue.dispatch(action, setState)\n    },\n    [actionQueue]\n  )\n\n  // Sync is called after a state update in the HistoryUpdater,\n  // for debugging purposes. Since the reducer state may be a Promise,\n  // we let the app router use() it and sync on the resolved value if\n  // something changed.\n  // Using the `state` here would be referentially unstable and cause\n  // undesirable re-renders and history updates.\n  const sync = useCallback<ReduxDevtoolsSyncFn>((resolvedState) => {\n    if (devtoolsConnectionRef.current) {\n      devtoolsConnectionRef.current.send(\n        { type: 'RENDER_SYNC' },\n        normalizeRouterState(resolvedState)\n      )\n    }\n  }, [])\n\n  return [state, dispatch, sync]\n}\n"],"names":["useReducerWithReduxDevtools","useUnwrapState","normalizeRouterState","val","Map","obj","key","value","entries","$$typeof","toString","_bundlerConfig","hasOwnProperty","Array","isArray","map","state","isThenable","result","use","actionQueue","setState","React","useState","devtoolsConnectionRef","useRef","undefined","enabledRef","useEffect","current","window","__REDUX_DEVTOOLS_EXTENSION__","connect","instanceId","name","init","devToolsInstance","dispatch","useCallback","action","sync","resolvedState","send","type"],"mappings":"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"}