{"version":3,"sources":["../../../../src/server/web/sandbox/context.ts"],"sourcesContent":["import type { AssetBinding } from '../../../build/webpack/loaders/get-module-build-info'\nimport type {\n  EdgeFunctionDefinition,\n  SUPPORTED_NATIVE_MODULES,\n} from '../../../build/webpack/plugins/middleware-plugin'\nimport type { UnwrapPromise } from '../../../lib/coalesced-function'\nimport { AsyncLocalStorage } from 'async_hooks'\nimport {\n  COMPILER_NAMES,\n  EDGE_UNSUPPORTED_NODE_APIS,\n} from '../../../shared/lib/constants'\nimport { EdgeRuntime } from 'next/dist/compiled/edge-runtime'\nimport { readFileSync, promises as fs } from 'fs'\nimport { validateURL } from '../utils'\nimport { pick } from '../../../lib/pick'\nimport { fetchInlineAsset } from './fetch-inline-assets'\nimport { runInContext } from 'vm'\nimport BufferImplementation from 'node:buffer'\nimport EventsImplementation from 'node:events'\nimport AssertImplementation from 'node:assert'\nimport UtilImplementation from 'node:util'\nimport AsyncHooksImplementation from 'node:async_hooks'\nimport { intervalsManager, timeoutsManager } from './resource-managers'\n\ninterface ModuleContext {\n  runtime: EdgeRuntime\n  paths: Map<string, string>\n  warnedEvals: Set<string>\n}\n\nlet getServerError: typeof import('../../../client/components/react-dev-overlay/server/middleware').getServerError\nlet decorateServerError: typeof import('../../../shared/lib/error-source').decorateServerError\n\nif (process.env.NODE_ENV === 'development') {\n  const middleware = require('../../../client/components/react-dev-overlay/server/middleware')\n  getServerError = middleware.getServerError\n  decorateServerError =\n    require('../../../shared/lib/error-source').decorateServerError\n} else {\n  getServerError = (error: Error, _: string) => error\n  decorateServerError = (_: Error, __: string) => {}\n}\n\n/**\n * A Map of cached module contexts indexed by the module name. It allows\n * to have a different cache scoped per module name or depending on the\n * provided module key on creation.\n */\nconst moduleContexts = new Map<string, ModuleContext>()\n\nconst pendingModuleCaches = new Map<string, Promise<ModuleContext>>()\n\n/**\n * Same as clearModuleContext but for all module contexts.\n */\nexport async function clearAllModuleContexts() {\n  intervalsManager.removeAll()\n  timeoutsManager.removeAll()\n  moduleContexts.clear()\n  pendingModuleCaches.clear()\n}\n\n/**\n * For a given path a context, this function checks if there is any module\n * context that contains the path with an older content and, if that's the\n * case, removes the context from the cache.\n *\n * This function also clears all intervals and timeouts created by the\n * module context.\n */\nexport async function clearModuleContext(path: string) {\n  intervalsManager.removeAll()\n  timeoutsManager.removeAll()\n\n  const handleContext = (\n    key: string,\n    cache: ReturnType<(typeof moduleContexts)['get']>,\n    context: typeof moduleContexts | typeof pendingModuleCaches\n  ) => {\n    if (cache?.paths.has(path)) {\n      context.delete(key)\n    }\n  }\n\n  for (const [key, cache] of moduleContexts) {\n    handleContext(key, cache, moduleContexts)\n  }\n  for (const [key, cache] of pendingModuleCaches) {\n    handleContext(key, await cache, pendingModuleCaches)\n  }\n}\n\nasync function loadWasm(\n  wasm: AssetBinding[]\n): Promise<Record<string, WebAssembly.Module>> {\n  const modules: Record<string, WebAssembly.Module> = {}\n\n  await Promise.all(\n    wasm.map(async (binding) => {\n      const module = await WebAssembly.compile(\n        await fs.readFile(binding.filePath)\n      )\n      modules[binding.name] = module\n    })\n  )\n\n  return modules\n}\n\nfunction buildEnvironmentVariablesFrom(\n  injectedEnvironments: Record<string, string>\n): Record<string, string | undefined> {\n  const pairs = Object.keys(process.env).map((key) => [key, process.env[key]])\n  const env = Object.fromEntries(pairs)\n  for (const key of Object.keys(injectedEnvironments)) {\n    env[key] = injectedEnvironments[key]\n  }\n  env.NEXT_RUNTIME = 'edge'\n  return env\n}\n\nfunction throwUnsupportedAPIError(name: string) {\n  const error =\n    new Error(`A Node.js API is used (${name}) which is not supported in the Edge Runtime.\nLearn more: https://nextjs.org/docs/api-reference/edge-runtime`)\n  decorateServerError(error, COMPILER_NAMES.edgeServer)\n  throw error\n}\n\nfunction createProcessPolyfill(env: Record<string, string>) {\n  const processPolyfill = { env: buildEnvironmentVariablesFrom(env) }\n  const overriddenValue: Record<string, any> = {}\n\n  for (const key of Object.keys(process)) {\n    if (key === 'env') continue\n    Object.defineProperty(processPolyfill, key, {\n      get() {\n        if (overriddenValue[key] !== undefined) {\n          return overriddenValue[key]\n        }\n        if (typeof (process as any)[key] === 'function') {\n          return () => throwUnsupportedAPIError(`process.${key}`)\n        }\n        return undefined\n      },\n      set(value) {\n        overriddenValue[key] = value\n      },\n      enumerable: false,\n    })\n  }\n  return processPolyfill\n}\n\nfunction addStub(context: EdgeRuntime['context'], name: string) {\n  Object.defineProperty(context, name, {\n    get() {\n      return function () {\n        throwUnsupportedAPIError(name)\n      }\n    },\n    enumerable: false,\n  })\n}\n\nfunction getDecorateUnhandledError(runtime: EdgeRuntime) {\n  const EdgeRuntimeError = runtime.evaluate(`Error`)\n  return (error: any) => {\n    if (error instanceof EdgeRuntimeError) {\n      decorateServerError(error, COMPILER_NAMES.edgeServer)\n    }\n  }\n}\n\nfunction getDecorateUnhandledRejection(runtime: EdgeRuntime) {\n  const EdgeRuntimeError = runtime.evaluate(`Error`)\n  return (rejected: { reason: typeof EdgeRuntimeError }) => {\n    if (rejected.reason instanceof EdgeRuntimeError) {\n      decorateServerError(rejected.reason, COMPILER_NAMES.edgeServer)\n    }\n  }\n}\n\nconst NativeModuleMap = (() => {\n  const mods: Record<\n    `node:${(typeof SUPPORTED_NATIVE_MODULES)[number]}`,\n    unknown\n  > = {\n    'node:buffer': pick(BufferImplementation, [\n      'constants',\n      'kMaxLength',\n      'kStringMaxLength',\n      'Buffer',\n      'SlowBuffer',\n    ]),\n    'node:events': pick(EventsImplementation, [\n      'EventEmitter',\n      'captureRejectionSymbol',\n      'defaultMaxListeners',\n      'errorMonitor',\n      'listenerCount',\n      'on',\n      'once',\n    ]),\n    'node:async_hooks': pick(AsyncHooksImplementation, [\n      'AsyncLocalStorage',\n      'AsyncResource',\n    ]),\n    'node:assert': pick(AssertImplementation, [\n      'AssertionError',\n      'deepEqual',\n      'deepStrictEqual',\n      'doesNotMatch',\n      'doesNotReject',\n      'doesNotThrow',\n      'equal',\n      'fail',\n      'ifError',\n      'match',\n      'notDeepEqual',\n      'notDeepStrictEqual',\n      'notEqual',\n      'notStrictEqual',\n      'ok',\n      'rejects',\n      'strict',\n      'strictEqual',\n      'throws',\n    ]),\n    'node:util': pick(UtilImplementation, [\n      '_extend' as any,\n      'callbackify',\n      'format',\n      'inherits',\n      'promisify',\n      'types',\n    ]),\n  }\n  return new Map(Object.entries(mods))\n})()\n\nexport const requestStore = new AsyncLocalStorage<{\n  headers: Headers\n}>()\n\n/**\n * Create a module cache specific for the provided parameters. It includes\n * a runtime context, require cache and paths cache.\n */\nasync function createModuleContext(options: ModuleContextOptions) {\n  const warnedEvals = new Set<string>()\n  const warnedWasmCodegens = new Set<string>()\n  const { edgeFunctionEntry } = options\n  const wasm = await loadWasm(edgeFunctionEntry.wasm ?? [])\n  const runtime = new EdgeRuntime({\n    codeGeneration:\n      process.env.NODE_ENV !== 'production'\n        ? { strings: true, wasm: true }\n        : undefined,\n    extend: (context) => {\n      context.process = createProcessPolyfill(edgeFunctionEntry.env)\n\n      Object.defineProperty(context, 'require', {\n        enumerable: false,\n        value: (id: string) => {\n          const value = NativeModuleMap.get(id)\n          if (!value) {\n            throw TypeError('Native module not found: ' + id)\n          }\n          return value\n        },\n      })\n\n      if (process.env.NODE_ENV !== 'production') {\n        context.__next_log_error__ = function (err: unknown) {\n          options.onError(err)\n        }\n      }\n\n      context.__next_eval__ = function __next_eval__(fn: Function) {\n        const key = fn.toString()\n        if (!warnedEvals.has(key)) {\n          const warning = getServerError(\n            new Error(\n              `Dynamic Code Evaluation (e. g. 'eval', 'new Function') not allowed in Edge Runtime\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`\n            ),\n            COMPILER_NAMES.edgeServer\n          )\n          warning.name = 'DynamicCodeEvaluationWarning'\n          Error.captureStackTrace(warning, __next_eval__)\n          warnedEvals.add(key)\n          options.onWarning(warning)\n        }\n        return fn()\n      }\n\n      context.__next_webassembly_compile__ =\n        function __next_webassembly_compile__(fn: Function) {\n          const key = fn.toString()\n          if (!warnedWasmCodegens.has(key)) {\n            const warning = getServerError(\n              new Error(`Dynamic WASM code generation (e. g. 'WebAssembly.compile') not allowed in Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`),\n              COMPILER_NAMES.edgeServer\n            )\n            warning.name = 'DynamicWasmCodeGenerationWarning'\n            Error.captureStackTrace(warning, __next_webassembly_compile__)\n            warnedWasmCodegens.add(key)\n            options.onWarning(warning)\n          }\n          return fn()\n        }\n\n      context.__next_webassembly_instantiate__ =\n        async function __next_webassembly_instantiate__(fn: Function) {\n          const result = await fn()\n\n          // If a buffer is given, WebAssembly.instantiate returns an object\n          // containing both a module and an instance while it returns only an\n          // instance if a WASM module is given. Utilize the fact to determine\n          // if the WASM code generation happens.\n          //\n          // https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiate#primary_overload_%E2%80%94_taking_wasm_binary_code\n          const instantiatedFromBuffer = result.hasOwnProperty('module')\n\n          const key = fn.toString()\n          if (instantiatedFromBuffer && !warnedWasmCodegens.has(key)) {\n            const warning = getServerError(\n              new Error(`Dynamic WASM code generation ('WebAssembly.instantiate' with a buffer parameter) not allowed in Edge Runtime.\nLearn More: https://nextjs.org/docs/messages/edge-dynamic-code-evaluation`),\n              COMPILER_NAMES.edgeServer\n            )\n            warning.name = 'DynamicWasmCodeGenerationWarning'\n            Error.captureStackTrace(warning, __next_webassembly_instantiate__)\n            warnedWasmCodegens.add(key)\n            options.onWarning(warning)\n          }\n          return result\n        }\n\n      const __fetch = context.fetch\n      context.fetch = async (input, init = {}) => {\n        const callingError = new Error('[internal]')\n        const assetResponse = await fetchInlineAsset({\n          input,\n          assets: options.edgeFunctionEntry.assets,\n          distDir: options.distDir,\n          context,\n        })\n        if (assetResponse) {\n          return assetResponse\n        }\n\n        init.headers = new Headers(init.headers ?? {})\n\n        // Forward subrequest header from incoming request to outgoing request\n        const store = requestStore.getStore()\n        if (\n          store?.headers.has('x-middleware-subrequest') &&\n          !init.headers.has('x-middleware-subrequest')\n        ) {\n          init.headers.set(\n            'x-middleware-subrequest',\n            store.headers.get('x-middleware-subrequest') ?? ''\n          )\n        }\n\n        const prevs =\n          init.headers.get(`x-middleware-subrequest`)?.split(':') || []\n        const value = prevs.concat(options.moduleName).join(':')\n        init.headers.set('x-middleware-subrequest', value)\n\n        if (!init.headers.has('user-agent')) {\n          init.headers.set(`user-agent`, `Next.js Middleware`)\n        }\n\n        const response =\n          typeof input === 'object' && 'url' in input\n            ? __fetch(input.url, {\n                ...pick(input, [\n                  'method',\n                  'body',\n                  'cache',\n                  'credentials',\n                  'integrity',\n                  'keepalive',\n                  'mode',\n                  'redirect',\n                  'referrer',\n                  'referrerPolicy',\n                  'signal',\n                ]),\n                ...init,\n                headers: {\n                  ...Object.fromEntries(input.headers),\n                  ...Object.fromEntries(init.headers),\n                },\n              })\n            : __fetch(String(input), init)\n\n        return await response.catch((err) => {\n          callingError.message = err.message\n          err.stack = callingError.stack\n          throw err\n        })\n      }\n\n      const __Request = context.Request\n      context.Request = class extends __Request {\n        next?: NextFetchRequestConfig | undefined\n        constructor(input: URL | RequestInfo, init?: RequestInit | undefined) {\n          const url =\n            typeof input !== 'string' && 'url' in input\n              ? input.url\n              : String(input)\n          validateURL(url)\n          super(url, init)\n          this.next = init?.next\n        }\n      }\n\n      const __redirect = context.Response.redirect.bind(context.Response)\n      context.Response.redirect = (...args) => {\n        validateURL(args[0])\n        return __redirect(...args)\n      }\n\n      for (const name of EDGE_UNSUPPORTED_NODE_APIS) {\n        addStub(context, name)\n      }\n\n      Object.assign(context, wasm)\n\n      context.performance = performance\n\n      context.AsyncLocalStorage = AsyncLocalStorage\n\n      // @ts-ignore the timeouts have weird types in the edge runtime\n      context.setInterval = (...args: Parameters<typeof setInterval>) =>\n        intervalsManager.add(args)\n\n      // @ts-ignore the timeouts have weird types in the edge runtime\n      context.clearInterval = (interval: number) =>\n        intervalsManager.remove(interval)\n\n      // @ts-ignore the timeouts have weird types in the edge runtime\n      context.setTimeout = (...args: Parameters<typeof setTimeout>) =>\n        timeoutsManager.add(args)\n\n      // @ts-ignore the timeouts have weird types in the edge runtime\n      context.clearTimeout = (timeout: number) =>\n        timeoutsManager.remove(timeout)\n\n      return context\n    },\n  })\n\n  const decorateUnhandledError = getDecorateUnhandledError(runtime)\n  runtime.context.addEventListener('error', decorateUnhandledError)\n  const decorateUnhandledRejection = getDecorateUnhandledRejection(runtime)\n  runtime.context.addEventListener(\n    'unhandledrejection',\n    decorateUnhandledRejection\n  )\n\n  return {\n    runtime,\n    paths: new Map<string, string>(),\n    warnedEvals: new Set<string>(),\n  }\n}\n\ninterface ModuleContextOptions {\n  moduleName: string\n  onError: (err: unknown) => void\n  onWarning: (warn: Error) => void\n  useCache: boolean\n  distDir: string\n  edgeFunctionEntry: Pick<EdgeFunctionDefinition, 'assets' | 'wasm' | 'env'>\n}\n\nfunction getModuleContextShared(options: ModuleContextOptions) {\n  let deferredModuleContext = pendingModuleCaches.get(options.moduleName)\n  if (!deferredModuleContext) {\n    deferredModuleContext = createModuleContext(options)\n    pendingModuleCaches.set(options.moduleName, deferredModuleContext)\n  }\n  return deferredModuleContext\n}\n\n/**\n * For a given module name this function will get a cached module\n * context or create it. It will return the module context along\n * with a function that allows to run some code from a given\n * filepath within the context.\n */\nexport async function getModuleContext(options: ModuleContextOptions): Promise<{\n  evaluateInContext: (filepath: string) => void\n  runtime: EdgeRuntime\n  paths: Map<string, string>\n  warnedEvals: Set<string>\n}> {\n  let lazyModuleContext:\n    | UnwrapPromise<ReturnType<typeof getModuleContextShared>>\n    | undefined\n\n  if (options.useCache) {\n    lazyModuleContext =\n      moduleContexts.get(options.moduleName) ||\n      (await getModuleContextShared(options))\n  }\n\n  if (!lazyModuleContext) {\n    lazyModuleContext = await createModuleContext(options)\n    moduleContexts.set(options.moduleName, lazyModuleContext)\n  }\n\n  const moduleContext = lazyModuleContext\n\n  const evaluateInContext = (filepath: string) => {\n    if (!moduleContext.paths.has(filepath)) {\n      const content = readFileSync(filepath, 'utf-8')\n      try {\n        runInContext(content, moduleContext.runtime.context, {\n          filename: filepath,\n        })\n        moduleContext.paths.set(filepath, content)\n      } catch (error) {\n        if (options.useCache) {\n          moduleContext?.paths.delete(filepath)\n        }\n        throw error\n      }\n    }\n  }\n\n  return { ...moduleContext, evaluateInContext }\n}\n"],"names":["clearAllModuleContexts","clearModuleContext","getModuleContext","requestStore","getServerError","decorateServerError","process","env","NODE_ENV","middleware","require","error","_","__","moduleContexts","Map","pendingModuleCaches","intervalsManager","removeAll","timeoutsManager","clear","path","handleContext","key","cache","context","paths","has","delete","loadWasm","wasm","modules","Promise","all","map","binding","module","WebAssembly","compile","fs","readFile","filePath","name","buildEnvironmentVariablesFrom","injectedEnvironments","pairs","Object","keys","fromEntries","NEXT_RUNTIME","throwUnsupportedAPIError","Error","COMPILER_NAMES","edgeServer","createProcessPolyfill","processPolyfill","overriddenValue","defineProperty","get","undefined","set","value","enumerable","addStub","getDecorateUnhandledError","runtime","EdgeRuntimeError","evaluate","getDecorateUnhandledRejection","rejected","reason","NativeModuleMap","mods","pick","BufferImplementation","EventsImplementation","AsyncHooksImplementation","AssertImplementation","UtilImplementation","entries","AsyncLocalStorage","createModuleContext","options","warnedEvals","Set","warnedWasmCodegens","edgeFunctionEntry","EdgeRuntime","codeGeneration","strings","extend","id","TypeError","__next_log_error__","err","onError","__next_eval__","fn","toString","warning","captureStackTrace","add","onWarning","__next_webassembly_compile__","__next_webassembly_instantiate__","result","instantiatedFromBuffer","hasOwnProperty","__fetch","fetch","input","init","callingError","assetResponse","fetchInlineAsset","assets","distDir","headers","Headers","store","getStore","prevs","split","concat","moduleName","join","response","url","String","catch","message","stack","__Request","Request","constructor","validateURL","next","__redirect","Response","redirect","bind","args","EDGE_UNSUPPORTED_NODE_APIS","assign","performance","setInterval","clearInterval","interval","remove","setTimeout","clearTimeout","timeout","decorateUnhandledError","addEventListener","decorateUnhandledRejection","getModuleContextShared","deferredModuleContext","lazyModuleContext","useCache","moduleContext","evaluateInContext","filepath","content","readFileSync","runInContext","filename"],"mappings":"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"}