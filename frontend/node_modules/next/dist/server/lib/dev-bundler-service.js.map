{"version":3,"sources":["../../../src/server/lib/dev-bundler-service.ts"],"sourcesContent":["import type { IncomingMessage } from 'http'\nimport type { DevBundler } from './router-utils/setup-dev-bundler'\nimport type { WorkerRequestHandler } from './types'\n\nimport LRUCache from 'next/dist/compiled/lru-cache'\nimport { createRequestResponseMocks } from './mock-request'\nimport { HMR_ACTIONS_SENT_TO_BROWSER } from '../dev/hot-reloader-types'\n\n/**\n * The DevBundlerService provides an interface to perform tasks with the\n * bundler while in development.\n */\nexport class DevBundlerService {\n  // can't leverage LRU type directly here as it\n  // isn't a direct dependency\n  public appIsrManifestInner: {\n    get(key: string): number | false\n    set(key: string, value: number | false): void\n    del(key: string): void\n    keys(): string[]\n  }\n\n  constructor(\n    private readonly bundler: DevBundler,\n    private readonly handler: WorkerRequestHandler\n  ) {\n    this.appIsrManifestInner = new LRUCache({\n      max: 8_000,\n      length() {\n        return 16\n      },\n    }) as any\n  }\n\n  public ensurePage: typeof this.bundler.hotReloader.ensurePage = async (\n    definition\n  ) => {\n    // TODO: remove after ensure is pulled out of server\n    return await this.bundler.hotReloader.ensurePage(definition)\n  }\n\n  public logErrorWithOriginalStack: typeof this.bundler.logErrorWithOriginalStack =\n    async (...args) => {\n      return await this.bundler.logErrorWithOriginalStack(...args)\n    }\n\n  public async getFallbackErrorComponents(url?: string) {\n    await this.bundler.hotReloader.buildFallbackError()\n    // Build the error page to ensure the fallback is built too.\n    // TODO: See if this can be moved into hotReloader or removed.\n    await this.bundler.hotReloader.ensurePage({\n      page: '/_error',\n      clientOnly: false,\n      definition: undefined,\n      url,\n    })\n  }\n\n  public async getCompilationError(page: string) {\n    const errors = await this.bundler.hotReloader.getCompilationErrors(page)\n    if (!errors) return\n\n    // Return the very first error we found.\n    return errors[0]\n  }\n\n  public async revalidate({\n    urlPath,\n    revalidateHeaders,\n    opts: revalidateOpts,\n  }: {\n    urlPath: string\n    revalidateHeaders: IncomingMessage['headers']\n    opts: any\n  }) {\n    const mocked = createRequestResponseMocks({\n      url: urlPath,\n      headers: revalidateHeaders,\n    })\n\n    await this.handler(mocked.req, mocked.res)\n    await mocked.res.hasStreamed\n\n    if (\n      mocked.res.getHeader('x-nextjs-cache') !== 'REVALIDATED' &&\n      !(mocked.res.statusCode === 404 && revalidateOpts.unstable_onlyGenerated)\n    ) {\n      throw new Error(`Invalid response ${mocked.res.statusCode}`)\n    }\n\n    return {}\n  }\n\n  public get appIsrManifest() {\n    const serializableManifest: Record<string, false | number> = {}\n\n    for (const key of this.appIsrManifestInner.keys() as string[]) {\n      serializableManifest[key] = this.appIsrManifestInner.get(key) as\n        | false\n        | number\n    }\n    return serializableManifest\n  }\n\n  public setAppIsrStatus(key: string, value: false | number | null) {\n    if (value === null) {\n      this.appIsrManifestInner.del(key)\n    } else {\n      this.appIsrManifestInner.set(key, value)\n    }\n    this.bundler?.hotReloader?.send({\n      action: HMR_ACTIONS_SENT_TO_BROWSER.APP_ISR_MANIFEST,\n      data: this.appIsrManifest,\n    })\n  }\n}\n"],"names":["DevBundlerService","constructor","bundler","handler","ensurePage","definition","hotReloader","logErrorWithOriginalStack","args","appIsrManifestInner","LRUCache","max","length","getFallbackErrorComponents","url","buildFallbackError","page","clientOnly","undefined","getCompilationError","errors","getCompilationErrors","revalidate","urlPath","revalidateHeaders","opts","revalidateOpts","mocked","createRequestResponseMocks","headers","req","res","hasStreamed","getHeader","statusCode","unstable_onlyGenerated","Error","appIsrManifest","serializableManifest","key","keys","get","setAppIsrStatus","value","del","set","send","action","HMR_ACTIONS_SENT_TO_BROWSER","APP_ISR_MANIFEST","data"],"mappings":";;;;+BAYaA;;;eAAAA;;;iEARQ;6BACsB;kCACC;;;;;;AAMrC,MAAMA;IAUXC,YACE,AAAiBC,OAAmB,EACpC,AAAiBC,OAA6B,CAC9C;aAFiBD,UAAAA;aACAC,UAAAA;aAUZC,aAAyD,OAC9DC;YAEA,oDAAoD;YACpD,OAAO,MAAM,IAAI,CAACH,OAAO,CAACI,WAAW,CAACF,UAAU,CAACC;QACnD;aAEOE,4BACL,OAAO,GAAGC;YACR,OAAO,MAAM,IAAI,CAACN,OAAO,CAACK,yBAAyB,IAAIC;QACzD;QAlBA,IAAI,CAACC,mBAAmB,GAAG,IAAIC,iBAAQ,CAAC;YACtCC,KAAK;YACLC;gBACE,OAAO;YACT;QACF;IACF;IAcA,MAAaC,2BAA2BC,GAAY,EAAE;QACpD,MAAM,IAAI,CAACZ,OAAO,CAACI,WAAW,CAACS,kBAAkB;QACjD,4DAA4D;QAC5D,8DAA8D;QAC9D,MAAM,IAAI,CAACb,OAAO,CAACI,WAAW,CAACF,UAAU,CAAC;YACxCY,MAAM;YACNC,YAAY;YACZZ,YAAYa;YACZJ;QACF;IACF;IAEA,MAAaK,oBAAoBH,IAAY,EAAE;QAC7C,MAAMI,SAAS,MAAM,IAAI,CAAClB,OAAO,CAACI,WAAW,CAACe,oBAAoB,CAACL;QACnE,IAAI,CAACI,QAAQ;QAEb,wCAAwC;QACxC,OAAOA,MAAM,CAAC,EAAE;IAClB;IAEA,MAAaE,WAAW,EACtBC,OAAO,EACPC,iBAAiB,EACjBC,MAAMC,cAAc,EAKrB,EAAE;QACD,MAAMC,SAASC,IAAAA,uCAA0B,EAAC;YACxCd,KAAKS;YACLM,SAASL;QACX;QAEA,MAAM,IAAI,CAACrB,OAAO,CAACwB,OAAOG,GAAG,EAAEH,OAAOI,GAAG;QACzC,MAAMJ,OAAOI,GAAG,CAACC,WAAW;QAE5B,IACEL,OAAOI,GAAG,CAACE,SAAS,CAAC,sBAAsB,iBAC3C,CAAEN,CAAAA,OAAOI,GAAG,CAACG,UAAU,KAAK,OAAOR,eAAeS,sBAAsB,AAAD,GACvE;YACA,MAAM,IAAIC,MAAM,CAAC,iBAAiB,EAAET,OAAOI,GAAG,CAACG,UAAU,CAAC,CAAC;QAC7D;QAEA,OAAO,CAAC;IACV;IAEA,IAAWG,iBAAiB;QAC1B,MAAMC,uBAAuD,CAAC;QAE9D,KAAK,MAAMC,OAAO,IAAI,CAAC9B,mBAAmB,CAAC+B,IAAI,GAAgB;YAC7DF,oBAAoB,CAACC,IAAI,GAAG,IAAI,CAAC9B,mBAAmB,CAACgC,GAAG,CAACF;QAG3D;QACA,OAAOD;IACT;IAEOI,gBAAgBH,GAAW,EAAEI,KAA4B,EAAE;YAMhE,2BAAA;QALA,IAAIA,UAAU,MAAM;YAClB,IAAI,CAAClC,mBAAmB,CAACmC,GAAG,CAACL;QAC/B,OAAO;YACL,IAAI,CAAC9B,mBAAmB,CAACoC,GAAG,CAACN,KAAKI;QACpC;SACA,gBAAA,IAAI,CAACzC,OAAO,sBAAZ,4BAAA,cAAcI,WAAW,qBAAzB,0BAA2BwC,IAAI,CAAC;YAC9BC,QAAQC,6CAA2B,CAACC,gBAAgB;YACpDC,MAAM,IAAI,CAACb,cAAc;QAC3B;IACF;AACF"}